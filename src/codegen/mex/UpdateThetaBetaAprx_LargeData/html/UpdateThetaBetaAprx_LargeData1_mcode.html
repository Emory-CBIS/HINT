<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">theta_new</span>, <span class="var type1" id="S3T2U4">beta_new</span>, <span class="var type1" id="S4T4U5">z_mode</span>, <span class="var type1" id="S5T2U6">subICmean</span>, <span class="var type1" id="S6T5U7">subICvar</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line">        <span class="var type1" id="S7T6U8">grpICmean</span>, <span class="var type1" id="S8T2U9">grpICvar</span>, <span class="var type1" id="S9T3U10">err</span>, <span class="var type1" id="S10T2U11">G_z_dict</span>] = UpdateThetaBetaAprx_LargeData (<span class="var type1" id="S11T7U14">Y</span>, <span class="var type1" id="S12T8U15">X_mtx</span>, <span class="var type1" id="S13T9U16">theta</span>, <span class="var type1" id="S14T13U17">C_matrix_diag</span>, <span class="var type1" id="S15T14U18">beta</span>, <span class="var type1" id="S16T3U19">N</span>, <span class="var type1" id="S17T3U20">T</span>, <span class="var type1" id="S18T3U21">q</span>, <span class="var type1" id="S19T3U22">p</span>, <span class="var type1" id="S20T3U23">m</span>, <span class="var type1" id="S21T3U24">V</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%[theta_new, beta_new] = UpdateThetaBeta (Y, X_mtx, theta, beta, N, T, q, p, m, V)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% After preprocessing, T=q</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% Y           :  Y(:,V)  individual i scan time T at voxel v,      TN*V</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">% X_mtx       :  X(i,k)  predictor k for individual i,             p*N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% beta        :  beta (k, l, v)  coefficients at voxel v,          p*q*V</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">% C_matrix_diag: diagnal elements of C_matrix; % C matrix is (q * N)x1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">% miu_svi     :  E(si(v) | Y(v), theta)                            q*1*N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">% miu_sv      :  E(s(v)  | Y(v), theta)                            q*1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">% miu_svi_sviT:  E(si(v)si(v)'| Y(v), theta)                       q*q*N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% miu_sv_svT  :  E(s(v)s(v)'  | Y(v), theta)                       q*q</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">% miu_sv_sviT :  E(s(v)si(v)' | Y(v), theta)                       q*q*N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% First calculate the conditional probability of ICs given the data and</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% latent sorce state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="keyword">global</span> <span class="var type0" id="S22T0U26">keeplist</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="mxinfo " id="T3:U21"><span class="var type1" id="S9T3U29">err</span>=<span class="mxinfo " id="T3:U23">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="mxinfo " id="T2:U24"><span class="potentialdiff PD1"><span class="mxinfo " id="T2:U25"><span class="var type1" id="S2T1U34">theta_new</span>.A</span>         = <span class="mxinfo " id="T2:U27">zeros(<span class="mxinfo " id="T3:U28"><span class="var type1" id="S17T3U38"><span class="potentialdiff PD1">T</span></span></span>, <span class="mxinfo " id="T3:U29"><span class="var type1" id="S18T3U39"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U30"><span class="var type1" id="S16T3U40"><span class="potentialdiff PD1">N</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="mxinfo " id="T3:U31"><span class="mxinfo " id="T3:U32"><span class="var type1" id="S2T1U44">theta_new</span>.sigma1_sq</span> = <span class="mxinfo " id="T3:U34">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="mxinfo " id="T4:U35"><span class="mxinfo " id="T4:U36"><span class="var type1" id="S2T1U50">theta_new</span>.sigma2_sq</span> = <span class="mxinfo " id="T4:U38">zeros(<span class="mxinfo " id="T3:U39"><span class="var type1" id="S18T3U54"><span class="potentialdiff PD1">q</span></span></span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="mxinfo " id="T4:U40"><span class="potentialdiff PD1"><span class="mxinfo " id="T4:U41"><span class="var type1" id="S2T1U59">theta_new</span>.miu3</span>      = <span class="mxinfo " id="T4:U43">zeros(<span class="mxinfo " id="T3:U44"><span class="var type1" id="S20T3U64">m</span>*<span class="var type1" id="S18T3U65">q</span></span>, 1)</span></span></span>;   <span class="comment">%pi, miu3, sigma3 in the order of miul1,<span class="keyword">...</span><span class="comment">,miulm, l=1:q</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="mxinfo " id="T4:U47"><span class="potentialdiff PD1"><span class="mxinfo " id="T4:U48"><span class="var type1" id="S2T1U70">theta_new</span>.sigma3_sq</span> = <span class="mxinfo " id="T4:U50">zeros(<span class="mxinfo " id="T3:U51"><span class="var type1" id="S20T3U75">m</span>*<span class="var type1" id="S18T3U76">q</span></span>, 1)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T4:U54"><span class="potentialdiff PD1"><span class="mxinfo " id="T4:U55"><span class="var type1" id="S2T1U81">theta_new</span>.pi</span>        = <span class="mxinfo " id="T4:U57">zeros(<span class="mxinfo " id="T3:U58"><span class="var type1" id="S20T3U86">m</span>*<span class="var type1" id="S18T3U87">q</span></span>, 1)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo " id="T2:U61"><span class="potentialdiff PD1"><span class="var type1" id="S3T2U91">beta_new</span>            = <span class="mxinfo " id="T2:U63">zeros(<span class="mxinfo " id="T3:U64"><span class="var type1" id="S19T3U94"><span class="potentialdiff PD1">p</span></span></span>, <span class="mxinfo " id="T3:U65"><span class="var type1" id="S18T3U95"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U66"><span class="var type1" id="S21T3U96"><span class="potentialdiff PD1">V</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="mxinfo " id="T2:U67"><span class="potentialdiff PD1"><span class="var type1" id="S24T2U99">A_ProdPart1</span>         = <span class="mxinfo " id="T2:U69">zeros(<span class="mxinfo " id="T3:U70"><span class="var type1" id="S17T3U102"><span class="potentialdiff PD1">T</span></span></span>, <span class="mxinfo " id="T3:U71"><span class="var type1" id="S18T3U103"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U72"><span class="var type1" id="S16T3U104"><span class="potentialdiff PD1">N</span></span></span>)</span></span></span>;  <span class="comment">%first part of the product format for Ai</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="mxinfo " id="T2:U73"><span class="potentialdiff PD1"><span class="var type1" id="S25T2U107">A_ProdPart2</span>         = <span class="mxinfo " id="T2:U75">zeros(<span class="mxinfo " id="T3:U76"><span class="var type1" id="S18T3U110"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U77"><span class="var type1" id="S18T3U111"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U78"><span class="var type1" id="S16T3U112"><span class="potentialdiff PD1">N</span></span></span>)</span></span></span>;  <span class="comment">%second part of the product format for Ai</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">%sigma2_sq_all       = zeros(q, q);     %%% record all second level variance-covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo " id="T2:U79"><span class="potentialdiff PD1"><span class="var type1" id="S26T2U115">sigma2_sq_all_V</span>       = <span class="mxinfo " id="T2:U81">zeros(<span class="mxinfo " id="T3:U82"><span class="var type1" id="S18T3U118"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U83"><span class="var type1" id="S18T3U119"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U84"><span class="var type1" id="S21T3U120"><span class="potentialdiff PD1">V</span></span></span>)</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">coder.extrinsic(<span class="string">'mvnpdf'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">coder.extrinsic(<span class="string">'mtimesx'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="mxinfo " id="T4:U85"><span class="var type1" id="S4T4U135">z_mode</span> = <span class="mxinfo " id="T4:U87">zeros(<span class="mxinfo " id="T3:U88"><span class="var type1" id="S21T3U138"><span class="potentialdiff PD1">V</span></span></span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="mxinfo " id="T15:U89"><span class="var type1" id="S28T15U142">X</span>  = <span class="mxinfo " id="T15:U91">reshape(<span class="var type1" id="S12T8U145">X_mtx</span>, <span class="mxinfo " id="T3:U93"><span class="var type1" id="S16T3U147">N</span>*<span class="var type1" id="S19T3U148">p</span></span>, 1)</span></span>; <span class="comment">%reshape by column</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="mxinfo " id="T16:U96"><span class="var type1" id="S30T16U152">sumXiXiT_inv</span>  = <span class="mxinfo " id="T16:U98"><span class="mxinfo " id="T6:U99">eye(<span class="var type1" id="S19T3U156">p</span>)</span>/(<span class="mxinfo " id="T17:U101"><span class="var type1" id="S12T8U159">X_mtx</span>*<span class="mxinfo " id="T18:U103"><span class="var type1" id="S12T8U161">X_mtx</span>'</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="mxinfo " id="T2:U105"><span class="var type1" id="S5T2U164">subICmean</span> = <span class="mxinfo " id="T2:U107">zeros(<span class="mxinfo " id="T3:U108"><span class="var type1" id="S18T3U167"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U109"><span class="var type1" id="S16T3U168"><span class="potentialdiff PD1">N</span></span></span>, <span class="mxinfo " id="T3:U110"><span class="var type1" id="S21T3U169"><span class="potentialdiff PD1">V</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="mxinfo " id="T5:U111"><span class="var type1" id="S6T5U172">subICvar</span> = <span class="mxinfo " id="T5:U113">zeros(<span class="mxinfo " id="T3:U114"><span class="var type1" id="S18T3U175"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U115"><span class="var type1" id="S18T3U176"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U116"><span class="var type1" id="S16T3U177"><span class="potentialdiff PD1">N</span></span></span>, <span class="mxinfo " id="T3:U117"><span class="var type1" id="S21T3U178"><span class="potentialdiff PD1">V</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="mxinfo " id="T6:U118"><span class="var type1" id="S7T6U181">grpICmean</span> = <span class="mxinfo " id="T6:U120">zeros(<span class="mxinfo " id="T3:U121"><span class="var type1" id="S18T3U184"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U122"><span class="var type1" id="S21T3U185"><span class="potentialdiff PD1">V</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="mxinfo " id="T2:U123"><span class="var type1" id="S8T2U188">grpICvar</span> = <span class="mxinfo " id="T2:U125">zeros(<span class="mxinfo " id="T3:U126"><span class="var type1" id="S18T3U191"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U127"><span class="var type1" id="S18T3U192"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U128"><span class="var type1" id="S21T3U193"><span class="potentialdiff PD1">V</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="mxinfo " id="T6:U129"><span class="potentialdiff PD1"><span class="var type1" id="S32T6U196">A</span>   = <span class="mxinfo " id="T6:U131">zeros(<span class="mxinfo " id="T3:U132"><span class="potentialdiff PD1"><span class="var type1" id="S16T3U200">N</span>*<span class="var type1" id="S17T3U201">T</span></span></span>, <span class="mxinfo " id="T3:U135"><span class="potentialdiff PD1"><span class="var type1" id="S16T3U203">N</span>*<span class="var type1" id="S18T3U204">q</span></span></span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="mxinfo " id="T6:U138"><span class="var type1" id="S33T6U207">C_inv</span> = <span class="mxinfo " id="T6:U140">zeros(<span class="mxinfo " id="T3:U141"><span class="var type1" id="S17T3U210"><span class="potentialdiff PD1">T</span></span></span>, <span class="mxinfo " id="T3:U142"><span class="var type1" id="S16T3U211"><span class="potentialdiff PD1">N</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S34T3U214">i</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U144">1</span>:<span class="var type1" id="S16T3U217">N</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">    <span class="mxinfo " id="T6:U146"><span class="mxinfo " id="T6:U147"><span class="var type1" id="S32T6U221">A</span>( <span class="mxinfo " id="T4:U149"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U150"><span class="mxinfo " id="T3:U151">(<span class="mxinfo " id="T3:U152"><span class="var type1" id="S34T3U227">i</span>-<span class="mxinfo " id="T3:U154">1</span></span>)*<span class="var type1" id="S17T3U229">T</span></span>+1</span>:<span class="mxinfo " id="T3:U156">(<span class="var type1" id="S34T3U235">i</span>-1)*<span class="var type1" id="S17T3U237">T</span>+<span class="var type1" id="S17T3U238">T</span></span></span></span> , <span class="mxinfo " id="T4:U160"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U161"><span class="mxinfo " id="T3:U162">(<span class="mxinfo " id="T3:U163"><span class="var type1" id="S34T3U244">i</span>-<span class="mxinfo " id="T3:U165">1</span></span>)*<span class="var type1" id="S18T3U246">q</span></span>+1</span>:<span class="mxinfo " id="T3:U167">(<span class="var type1" id="S34T3U252">i</span>-1)*<span class="var type1" id="S18T3U254">q</span>+<span class="var type1" id="S18T3U255">q</span></span></span></span>)</span> = <span class="mxinfo " id="T19:U171"><span class="mxinfo " id="T12:U172"><span class="var type1" id="S13T9U258">theta</span>.A</span>(<span class="mxinfo " id="T20:U174">:</span>,<span class="mxinfo " id="T20:U175">:</span>,<span class="var type1" id="S34T3U262">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">    <span class="mxinfo " id="T4:U177"><span class="mxinfo " id="T4:U178"><span class="var type1" id="S33T6U266">C_inv</span>(<span class="mxinfo " id="T21:U180">:</span>,<span class="mxinfo " id="T3:U181"><span class="var type1" id="S34T3U268"><span class="potentialdiff PD3">i</span></span></span>)</span> = <span class="mxinfo " id="T22:U182">1./<span class="mxinfo " id="T22:U183"><span class="var type1" id="S14T13U272">C_matrix_diag</span>(<span class="mxinfo " id="T23:U185">(<span class="mxinfo " id="T3:U186"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U187"><span class="mxinfo " id="T3:U188"><span class="var type1" id="S17T3U278">T</span>*<span class="var type1" id="S34T3U279">i</span></span>-<span class="var type1" id="S17T3U280">T</span></span>+<span class="mxinfo " id="T3:U192">1</span></span></span>):<span class="var type1" id="S17T3U283">T</span>*<span class="var type1" id="S34T3U284">i</span></span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="mxinfo " id="T6:U195"><span class="var type1" id="S35T6U287">B</span>   =   <span class="mxinfo " id="T6:U197">kron(<span class="mxinfo " id="T4:U198">ones(<span class="mxinfo " id="T3:U199"><span class="var type1" id="S16T3U292"><span class="potentialdiff PD1">N</span></span></span>, 1)</span>, <span class="mxinfo " id="T6:U200">eye(<span class="var type1" id="S18T3U296">q</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">%W2  =   [A, A*B];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="mxinfo " id="T6:U202"><span class="var type1" id="S38T6U299">W2</span> = <span class="mxinfo " id="T6:U204">[<span class="mxinfo " id="T6:U205">eye(<span class="mxinfo " id="T3:U206"><span class="var type1" id="S16T3U305">N</span>*<span class="var type1" id="S18T3U306">q</span></span>)</span>, <span class="var type1" id="S35T6U307">B</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="mxinfo " id="T6:U210"><span class="var type1" id="S39T6U310">P</span>   =   <span class="mxinfo " id="T6:U212">[ <span class="mxinfo " id="T6:U213"><span class="mxinfo " id="T6:U214">eye(<span class="mxinfo " id="T3:U215"><span class="var type1" id="S16T3U316">N</span>*<span class="var type1" id="S18T3U317">q</span></span>)</span> , <span class="var type1" id="S35T6U318">B</span></span>; <span class="mxinfo " id="T6:U219"><span class="mxinfo " id="T6:U220">zeros(<span class="mxinfo " id="T3:U221"><span class="var type1" id="S18T3U322"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U222"><span class="potentialdiff PD1"><span class="var type1" id="S16T3U324">N</span>*<span class="var type1" id="S18T3U325">q</span></span></span>)</span>, <span class="mxinfo " id="T6:U225">eye(<span class="var type1" id="S18T3U328">q</span>)</span></span> ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="mxinfo " id="T24:U227"><span class="var type1" id="S40T24U331">Sigma1</span>   =   <span class="mxinfo " id="T24:U229">diag(<span class="mxinfo " id="T13:U230"><span class="var type1" id="S14T13U335">C_matrix_diag</span>.*<span class="mxinfo " id="T3:U232"><span class="var type1" id="S13T9U337">theta</span>.sigma1_sq</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="mxinfo " id="T24:U234"><span class="var type1" id="S42T24U341">Sigma1_inv</span> = <span class="mxinfo " id="T24:U236">diag(<span class="mxinfo " id="T13:U237">1./<span class="mxinfo " id="T13:U238">diag(<span class="var type1" id="S40T24U348">Sigma1</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="mxinfo " id="T6:U240"><span class="var type1" id="S43T6U351">Sigma2</span>   =   <span class="mxinfo " id="T6:U242">kron(<span class="mxinfo " id="T6:U243">eye(<span class="var type1" id="S16T3U356">N</span>)</span>, <span class="mxinfo " id="T19:U245">diag(<span class="mxinfo " id="T11:U246"><span class="var type1" id="S13T9U360">theta</span>.sigma2_sq</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="mxinfo " id="T25:U248"><span class="var type1" id="S44T25U364">Sigma_gamma0</span>  =   <span class="mxinfo " id="T25:U250"><span class="potentialdiff PD4"><span class="mxinfo " id="T26:U251"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U252"><span class="var type1" id="S38T6U368">W2</span>'</span> * <span class="var type1" id="S42T24U369">Sigma1_inv</span></span></span> * <span class="var type1" id="S38T6U370">W2</span></span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%%%%% dictionary for the z(v) s</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="mxinfo " id="T6:U256"><span class="var type1" id="S45T6U373">z_dict</span> = <span class="mxinfo " id="T6:U258">[<span class="mxinfo " id="T6:U259"><span class="potentialdiff PD5"><span class="mxinfo " id="T6:U260"><span class="mxinfo " id="T3:U261">2</span>*<span class="mxinfo " id="T6:U262">ones(<span class="mxinfo " id="T3:U263"><span class="var type1" id="S18T3U381"><span class="potentialdiff PD1">q</span></span></span>)</span></span>-<span class="mxinfo " id="T6:U264">eye(<span class="var type1" id="S18T3U384">q</span>)</span></span></span>, <span class="mxinfo " id="T4:U266"><span class="mxinfo " id="T3:U267">2</span>*<span class="mxinfo " id="T4:U268">ones(<span class="mxinfo " id="T3:U269"><span class="var type1" id="S18T3U389"><span class="potentialdiff PD1">q</span></span></span>, 1)</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="mxinfo " id="T2:U270"><span class="potentialdiff PD1"><span class="var type1" id="S10T2U393">G_z_dict</span> = <span class="mxinfo " id="T2:U272">zeros(<span class="mxinfo " id="T3:U273"><span class="var type1" id="S18T3U396"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U274"><span class="potentialdiff PD1"><span class="var type1" id="S20T3U398">m</span>*<span class="var type1" id="S18T3U399">q</span></span></span>, <span class="mxinfo " id="T3:U277"><span class="potentialdiff PD1"><span class="var type1" id="S18T3U401">q</span>+<span class="mxinfo " id="T3:U279">1</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S34T3U405">i</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U281">1</span>:(<span class="mxinfo " id="T3:U282"><span class="var type1" id="S18T3U410">q</span>+<span class="mxinfo " id="T3:U284">1</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">    <span class="mxinfo " id="T6:U285"><span class="mxinfo " id="T6:U286"><span class="var type1" id="S10T2U415">G_z_dict</span>(<span class="mxinfo " id="T21:U288">:</span>,<span class="mxinfo " id="T21:U289">:</span>,<span class="mxinfo " id="T3:U290"><span class="var type1" id="S34T3U418"><span class="potentialdiff PD3">i</span></span></span>)</span> = <span class="mxinfo " id="T6:U291"><span class="fcn" id="F434N2:B420">G_zv_gen</span>(<span class="mxinfo " id="T4:U292"><span class="var type1" id="S45T6U422">z_dict</span>(<span class="mxinfo " id="T21:U294">:</span>,<span class="var type1" id="S34T3U424">i</span>)</span>, <span class="var type1" id="S20T3U425">m</span>, <span class="var type1" id="S18T3U426">q</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="mxinfo " id="T4:U298"><span class="var type1" id="S47T4U429">VoxelIC</span> = <span class="mxinfo " id="T4:U300">zeros(<span class="mxinfo " id="T3:U301"><span class="var type1" id="S21T3U432"><span class="potentialdiff PD1">V</span></span></span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="comment">%%% Main V loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S48T3U436">v</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U303">1</span>:<span class="var type1" id="S21T3U439">V</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">    <span class="mxinfo " id="T27:U305"><span class="var type1" id="S49T27U442">beta_v</span> = <span class="mxinfo " id="T27:U307"><span class="var type1" id="S15T14U444">beta</span>(<span class="mxinfo " id="T28:U309">:</span>,<span class="mxinfo " id="T20:U310">:</span>,<span class="var type1" id="S48T3U447">v</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    <span class="comment">% E-Step: generating all moments for updating</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">    <span class="mxinfo " id="T29:U312"><span class="var type1" id="S50T29U450">Y_v</span>  = <span class="mxinfo " id="T29:U314"><span class="var type1" id="S11T7U452">Y</span>(<span class="mxinfo " id="T30:U316">:</span>, <span class="var type1" id="S48T3U454">v</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">    <span class="mxinfo " id="T6:U318"><span class="var type1" id="S51T6U457">Beta_v_trans</span> =    <span class="mxinfo " id="T6:U320">kron(<span class="mxinfo " id="T6:U321">eye(<span class="var type1" id="S16T3U462">N</span>)</span>, <span class="mxinfo " id="T31:U323"><span class="var type1" id="S49T27U464">beta_v</span>'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="mxinfo " id="T4:U325"><span class="potentialdiff PD1"><span class="var type1" id="S52T4U467">Probzv</span> =   <span class="mxinfo " id="T4:U327">zeros(<span class="mxinfo " id="T3:U328"><span class="var type1" id="S18T3U471">q</span>+<span class="mxinfo " id="T3:U330">1</span></span>, 1)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    <span class="comment">% Save moments conditional on z_r</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">    <span class="mxinfo " id="T32:U331"><span class="var type1" id="S53T32U476">miu_sv_all_condz</span>     = <span class="mxinfo " id="T32:U333">zeros( <span class="mxinfo " id="T3:U334"><span class="potentialdiff PD1">(<span class="mxinfo " id="T3:U335"><span class="var type1" id="S16T3U482">N</span>+<span class="mxinfo " id="T3:U337">1</span></span>)*<span class="var type1" id="S18T3U484">q</span></span></span>,   <span class="mxinfo " id="T3:U339">1</span>,     <span class="mxinfo " id="T3:U340"><span class="potentialdiff PD1"><span class="var type1" id="S18T3U487">q</span>+<span class="mxinfo " id="T3:U342">1</span></span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">    <span class="mxinfo " id="T2:U343"><span class="var type1" id="S54T2U491">miu_sv_svT_all_condz</span> = <span class="mxinfo " id="T2:U345">zeros( <span class="mxinfo " id="T3:U346"><span class="potentialdiff PD1">(<span class="mxinfo " id="T3:U347"><span class="var type1" id="S16T3U497">N</span>+<span class="mxinfo " id="T3:U349">1</span></span>)*<span class="var type1" id="S18T3U499">q</span></span></span>, <span class="mxinfo " id="T3:U351"><span class="potentialdiff PD1">(<span class="mxinfo " id="T3:U352"><span class="var type1" id="S16T3U503">N</span>+<span class="mxinfo " id="T3:U354">1</span></span>)*<span class="var type1" id="S18T3U505">q</span></span></span>,  <span class="mxinfo " id="T3:U356"><span class="potentialdiff PD1"><span class="var type1" id="S18T3U507">q</span>+<span class="mxinfo " id="T3:U358">1</span></span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U511">i</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U360">1</span>:(<span class="mxinfo " id="T3:U361"><span class="var type1" id="S18T3U516">q</span>+<span class="mxinfo " id="T3:U363">1</span></span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">            <span class="comment">% Get the Z configuration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">            <span class="mxinfo " id="T6:U364"><span class="var type1" id="S55T6U520">G_z</span> = <span class="mxinfo " id="T6:U366"><span class="var type1" id="S10T2U522">G_z_dict</span>(<span class="mxinfo " id="T21:U368">:</span>,<span class="mxinfo " id="T21:U369">:</span>,<span class="var type1" id="S34T3U525">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">            <span class="mxinfo " id="T4:U371"><span class="var type1" id="S56T4U528">miu3z</span> = <span class="mxinfo " id="T4:U373"><span class="potentialdiff PD4"><span class="var type1" id="S55T6U530">G_z</span>*<span class="mxinfo " id="T10:U375"><span class="var type1" id="S13T9U532">theta</span>.miu3</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">            <span class="comment">% Calculate Y star</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">            <span class="mxinfo " id="T4:U377"><span class="var type1" id="S57T4U536">miu_temp</span> = <span class="mxinfo " id="T4:U379"><span class="potentialdiff PD5"><span class="mxinfo " id="T4:U380"><span class="potentialdiff PD4"><span class="var type1" id="S35T6U539">B</span>*<span class="var type1" id="S56T4U540">miu3z</span></span></span> + <span class="mxinfo " id="T4:U383"><span class="potentialdiff PD4"><span class="var type1" id="S51T6U542">Beta_v_trans</span>*<span class="var type1" id="S28T15U543">X</span></span></span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">            <span class="mxinfo " id="T4:U386"><span class="var type1" id="S58T4U546">Y_star</span>   = <span class="mxinfo " id="T4:U388"><span class="potentialdiff PD5"><span class="mxinfo " id="T4:U389"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U390"><span class="var type1" id="S32T6U550">A</span>'</span>*<span class="var type1" id="S50T29U551">Y_v</span></span></span> - <span class="var type1" id="S57T4U552">miu_temp</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">         </span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">            <span class="comment">% Calculate weighted probability</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">            <span class="mxinfo " id="T6:U394"><span class="var type1" id="S59T6U555">Sigma3z</span>  = <span class="mxinfo " id="T6:U396">diag(<span class="mxinfo " id="T4:U397"><span class="potentialdiff PD4"><span class="var type1" id="S55T6U559">G_z</span> * <span class="mxinfo " id="T10:U399"><span class="var type1" id="S13T9U561">theta</span>.sigma3_sq</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">            <span class="mxinfo " id="T6:U401"><span class="var type1" id="S60T6U565">Sigma23z</span> = <span class="mxinfo " id="T6:U403">blkdiag(<span class="var type1" id="S43T6U568">Sigma2</span>, <span class="var type1" id="S59T6U569">Sigma3z</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">            <span class="mxinfo " id="T4:U406"><span class="var type1" id="S62T4U572">pi_z</span> = <span class="mxinfo " id="T4:U408"><span class="potentialdiff PD4"><span class="var type1" id="S55T6U574">G_z</span> * <span class="mxinfo " id="T10:U410"><span class="var type1" id="S13T9U576">theta</span>.pi</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">            <span class="mxinfo " id="T24:U412"><span class="var type1" id="S63T24U580">mvn_cov</span> = <span class="mxinfo " id="T24:U414"><span class="mxinfo " id="T6:U415"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U416"><span class="potentialdiff PD4"><span class="var type1" id="S38T6U584">W2</span>*<span class="var type1" id="S60T6U585">Sigma23z</span></span></span>*<span class="mxinfo " id="T6:U419"><span class="var type1" id="S38T6U587">W2</span>'</span></span></span> + <span class="var type1" id="S40T24U588">Sigma1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">            <span class="comment">%%%% Approximate the above probability by factorization</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">            <span class="mxinfo " id="T3:U422"><span class="mxinfo " id="T3:U423"><span class="potentialdiff PD3"><span class="var type1" id="S52T4U592">Probzv</span>(<span class="var type1" id="S34T3U593">i</span>)</span></span> = <span class="mxinfo " id="T33:U426"><span class="mxinfo " id="T3:U427"><span class="potentialdiff PD6">sum( <span class="mxinfo " id="T4:U428"><span class="potentialdiff PD7">log(<span class="var type1" id="S62T4U599">pi_z</span>)</span></span> )</span></span> +<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">                <span class="mxinfo " id="T33:U430">sum( <span class="mxinfo " id="T13:U431"><span class="potentialdiff PD7">log( <span class="mxinfo " id="T13:U432"><span class="mxinfo " id="T13:U433"><span class="potentialdiff PD7">normpdf(<span class="var type1" id="S58T4U607">Y_star</span>, 0, <span class="mxinfo " id="T13:U435"><span class="potentialdiff PD7">sqrt(<span class="mxinfo " id="T13:U436">diag(<span class="var type1" id="S63T24U613">mvn_cov</span>)</span>)</span></span>)</span></span>  + <span class="mxinfo " id="T3:U438">0.00000000000000000001</span></span>)</span></span> )</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">                                   </span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">            <span class="comment">%display('MOVE THIS OUT OF LOOP!!!')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">%             Sigma_gamma  = eye((N+1)*q)/(Sigma_gamma0 + diag(1./diag(Sigma23z)));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="comment">%             miu_gamma    = Sigma_gamma*W2'*Sigma1_inv*Y_star;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">%             miu_star     = P * miu_gamma + [miu_temp; miu3z ];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%             Sigma_star   = P * Sigma_gamma * P';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="comment">%             miu_sv_all_condz (:, :, i)     = miu_star;                          %store first order moments from this iteration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="comment">%             miu_sv_svT_all_condz (:, :, i) = miu_star*miu_star'+Sigma_star;     %store second order moments from this interation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">    <span class="keyword">end</span> <span class="comment">% end of loop of Z configurations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">    [<span class="var type1" id="S68T3U618">val</span>, <span class="var type1" id="S69T3U619">maxid</span>] = max(<span class="var type1" id="S52T4U622">Probzv</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="mxinfo " id="T3:U442"><span class="var type1" id="S71T3U625">brokenVoxels</span> = <span class="mxinfo " id="T3:U444">sum(<span class="mxinfo " id="T34:U445"><span class="mxinfo " id="T3:U446">sum( <span class="mxinfo " id="T35:U447"><span class="var type1" id="S52T4U632">Probzv</span> == <span class="mxinfo " id="T3:U449">0</span></span>)</span> == <span class="mxinfo " id="T3:U450"><span class="var type1" id="S18T3U635">q</span>+<span class="mxinfo " id="T3:U452">1</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    <span class="keyword">if</span> (<span class="mxinfo " id="T34:U453"><span class="var type1" id="S71T3U641">brokenVoxels</span> == <span class="mxinfo " id="T3:U455">1</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="mxinfo " id="T3:U456"><span class="var type1" id="S71T3U645">brokenVoxels</span> = <span class="mxinfo " id="T3:U458">sum(<span class="mxinfo " id="T34:U459"><span class="mxinfo " id="T3:U460">sum( <span class="mxinfo " id="T35:U461"><span class="var type1" id="S52T4U652">Probzv</span> == <span class="mxinfo " id="T3:U463">-<span class="mxinfo " id="T3:U464">Inf</span></span></span>)</span> == <span class="mxinfo " id="T3:U465"><span class="var type1" id="S18T3U657">q</span>+<span class="mxinfo " id="T3:U467">1</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    <span class="keyword">if</span> (<span class="mxinfo " id="T34:U468"><span class="var type1" id="S71T3U663">brokenVoxels</span> == <span class="mxinfo " id="T3:U470">1</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    <span class="mxinfo " id="T3:U471"><span class="mxinfo " id="T3:U472"><span class="potentialdiff PD3"><span class="var type1" id="S47T4U668">VoxelIC</span>(<span class="var type1" id="S48T3U669">v</span>)</span></span> = <span class="var type1" id="S69T3U670">maxid</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">    <span class="mxinfo " id="T3:U476"><span class="mxinfo " id="T3:U477"><span class="potentialdiff PD3"><span class="var type1" id="S4T4U674">z_mode</span>(<span class="var type1" id="S48T3U675">v</span>)</span></span> = <span class="var type1" id="S69T3U676">maxid</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">    <span class="keyword">if</span>( <span class="mxinfo " id="T34:U481"><span class="mxinfo " id="T3:U482">sum(<span class="mxinfo " id="T35:U483">isnan(<span class="var type1" id="S52T4U685">Probzv</span>)</span>)</span> &gt;<span class="mxinfo " id="T3:U485">0</span></span> )    <span class="comment">%%%%% Handling errors when evaluating mvnpdf</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">        <span class="mxinfo " id="T3:U486"><span class="var type1" id="S9T3U689">err</span> = <span class="mxinfo " id="T3:U488">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">        error(<span class="string">'error in calculate Pr(z(v) | Y(v), theta) !'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">    <span class="comment">%%% Calculate miu_sv_all_condz, miu_sv_svT_all_condz for the maxid</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">    <span class="mxinfo " id="T6:U489"><span class="var type1" id="S55T6U697">G_z</span> = <span class="mxinfo " id="T6:U491"><span class="var type1" id="S10T2U699">G_z_dict</span>(<span class="mxinfo " id="T21:U493">:</span>,<span class="mxinfo " id="T21:U494">:</span>,<span class="var type1" id="S69T3U702">maxid</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">    <span class="mxinfo " id="T4:U496"><span class="var type1" id="S56T4U705">miu3z</span> = <span class="mxinfo " id="T4:U498"><span class="potentialdiff PD4"><span class="var type1" id="S55T6U707">G_z</span>*<span class="mxinfo " id="T10:U500"><span class="var type1" id="S13T9U709">theta</span>.miu3</span></span></span></span>;  </span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo " id="T4:U502"><span class="var type1" id="S57T4U713">miu_temp</span> = <span class="mxinfo " id="T4:U504"><span class="potentialdiff PD5"><span class="mxinfo " id="T4:U505"><span class="potentialdiff PD4"><span class="var type1" id="S35T6U716">B</span>*<span class="var type1" id="S56T4U717">miu3z</span></span></span> + <span class="mxinfo " id="T4:U508"><span class="potentialdiff PD4"><span class="var type1" id="S51T6U719">Beta_v_trans</span>*<span class="var type1" id="S28T15U720">X</span></span></span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    <span class="mxinfo " id="T4:U511"><span class="var type1" id="S58T4U723">Y_star</span>   = <span class="mxinfo " id="T4:U513"><span class="potentialdiff PD5"><span class="mxinfo " id="T4:U514"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U515"><span class="var type1" id="S32T6U727">A</span>'</span>*<span class="var type1" id="S50T29U728">Y_v</span></span></span> - <span class="var type1" id="S57T4U729">miu_temp</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">    <span class="comment">% Calculate weighted probability</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">    <span class="mxinfo " id="T6:U519"><span class="var type1" id="S59T6U732">Sigma3z</span>  = <span class="mxinfo " id="T6:U521">diag(<span class="mxinfo " id="T4:U522"><span class="potentialdiff PD4"><span class="var type1" id="S55T6U736">G_z</span> * <span class="mxinfo " id="T10:U524"><span class="var type1" id="S13T9U738">theta</span>.sigma3_sq</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">    <span class="mxinfo " id="T6:U526"><span class="var type1" id="S60T6U742">Sigma23z</span> = <span class="mxinfo " id="T6:U528">blkdiag(<span class="var type1" id="S43T6U745">Sigma2</span>, <span class="var type1" id="S59T6U746">Sigma3z</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">    <span class="comment">%display('MOVE THIS OUT OF LOOP!!!')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">    <span class="mxinfo " id="T25:U531"><span class="var type1" id="S75T25U749">Sigma_gamma</span>  = <span class="mxinfo " id="T25:U533"><span class="potentialdiff PD7"><span class="mxinfo " id="T6:U534">eye(<span class="mxinfo " id="T3:U535">(<span class="mxinfo " id="T3:U536"><span class="var type1" id="S16T3U756">N</span>+<span class="mxinfo " id="T3:U538">1</span></span>)*<span class="var type1" id="S18T3U758">q</span></span>)</span>/(<span class="mxinfo " id="T25:U540"><span class="potentialdiff PD5"><span class="var type1" id="S44T25U761">Sigma_gamma0</span> + <span class="mxinfo " id="T6:U542">diag(<span class="mxinfo " id="T4:U543">1./<span class="mxinfo " id="T4:U544"><span class="potentialdiff PD8">diag(<span class="var type1" id="S60T6U768">Sigma23z</span>)</span></span></span>)</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">    <span class="mxinfo " id="T36:U546"><span class="var type1" id="S76T36U771">miu_gamma</span>    = <span class="mxinfo " id="T36:U548"><span class="potentialdiff PD4"><span class="mxinfo " id="T26:U549"><span class="mxinfo " id="T25:U550"><span class="potentialdiff PD4"><span class="var type1" id="S75T25U775">Sigma_gamma</span>*<span class="mxinfo " id="T6:U552"><span class="var type1" id="S38T6U777">W2</span>'</span></span></span>*<span class="var type1" id="S42T24U778">Sigma1_inv</span></span>*<span class="var type1" id="S58T4U779">Y_star</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">    <span class="mxinfo " id="T36:U556"><span class="var type1" id="S77T36U782">miu_star</span>     = <span class="mxinfo " id="T36:U558"><span class="potentialdiff PD5"><span class="mxinfo " id="T36:U559"><span class="potentialdiff PD4"><span class="var type1" id="S39T6U785">P</span> * <span class="var type1" id="S76T36U786">miu_gamma</span></span></span> + <span class="mxinfo " id="T4:U562">[<span class="var type1" id="S57T4U789">miu_temp</span>; <span class="var type1" id="S56T4U791">miu3z</span> ]</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">    <span class="mxinfo " id="T25:U565"><span class="var type1" id="S78T25U794">Sigma_star</span>   = <span class="mxinfo " id="T25:U567"><span class="potentialdiff PD4"><span class="mxinfo " id="T25:U568"><span class="potentialdiff PD4"><span class="var type1" id="S39T6U797">P</span> * <span class="var type1" id="S75T25U798">Sigma_gamma</span></span></span> * <span class="mxinfo " id="T6:U571"><span class="var type1" id="S39T6U800">P</span>'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">    <span class="mxinfo " id="T36:U573"><span class="var type1" id="S79T36U803">miu_sv_all</span>     = <span class="var type1" id="S77T36U804">miu_star</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">    <span class="mxinfo " id="T25:U576"><span class="var type1" id="S80T25U807">miu_sv_svT_all</span> = <span class="mxinfo " id="T25:U578"><span class="potentialdiff PD5"><span class="mxinfo " id="T25:U579"><span class="var type1" id="S77T36U810">miu_star</span> * <span class="mxinfo " id="T37:U581"><span class="var type1" id="S77T36U812">miu_star</span>'</span></span>+<span class="var type1" id="S78T25U813">Sigma_star</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">    <span class="comment">%miu_sv_all     =  miu_sv_all_condz(:,:,maxid);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">   <span class="comment">% miu_sv_svT_all =  miu_sv_svT_all_condz(:,:,maxid);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">    <span class="comment">% E(si(v) | Y(v), theta)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">    <span class="mxinfo " id="T32:U584"><span class="var type1" id="S81T32U816">miu_svi</span>      = <span class="mxinfo " id="T32:U586">zeros(<span class="mxinfo " id="T3:U587"><span class="var type1" id="S18T3U819"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U588">1</span>, <span class="mxinfo " id="T3:U589"><span class="var type1" id="S16T3U821"><span class="potentialdiff PD1">N</span></span></span>)</span></span>;   <span class="comment">%first order moments of si(v) for each subject</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">    <span class="mxinfo " id="T2:U590"><span class="var type1" id="S82T2U824">miu_svi_sviT</span> = <span class="mxinfo " id="T2:U592">zeros(<span class="mxinfo " id="T3:U593"><span class="var type1" id="S18T3U827"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U594"><span class="var type1" id="S18T3U828"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U595"><span class="var type1" id="S16T3U829"><span class="potentialdiff PD1">N</span></span></span>)</span></span>;   <span class="comment">%second order moments of si(v) for each subject</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">    <span class="mxinfo " id="T2:U596"><span class="var type1" id="S83T2U832">miu_svi_svT</span>  = <span class="mxinfo " id="T2:U598">zeros(<span class="mxinfo " id="T3:U599"><span class="var type1" id="S18T3U835"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U600"><span class="var type1" id="S18T3U836"><span class="potentialdiff PD1">q</span></span></span>, <span class="mxinfo " id="T3:U601"><span class="var type1" id="S16T3U837"><span class="potentialdiff PD1">N</span></span></span>)</span></span>;   <span class="comment">%interactions between si(v) and s(v)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U840">i</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U603">1</span>: <span class="var type1" id="S16T3U843">N</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">        <span class="comment">%E(si(v) | Y(v), theta) = </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">        <span class="mxinfo " id="T4:U605"><span class="mxinfo " id="T4:U606"><span class="var type1" id="S81T32U847">miu_svi</span>      (<span class="mxinfo " id="T21:U608">:</span>, <span class="mxinfo " id="T38:U609">:</span>, <span class="mxinfo " id="T3:U610"><span class="var type1" id="S34T3U850"><span class="potentialdiff PD3">i</span></span></span>)</span> =  <span class="mxinfo " id="T36:U611"><span class="var type1" id="S79T36U852">miu_sv_all</span>( <span class="mxinfo " id="T39:U613">(<span class="mxinfo " id="T3:U614"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U615">(<span class="mxinfo " id="T3:U616"><span class="var type1" id="S34T3U859">i</span>-<span class="mxinfo " id="T3:U618">1</span></span>)*<span class="var type1" id="S18T3U861">q</span></span>+<span class="mxinfo " id="T3:U620">1</span></span></span>) : <span class="var type1" id="S34T3U864">i</span>*<span class="var type1" id="S18T3U865">q</span></span> , <span class="mxinfo " id="T38:U623">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">        <span class="mxinfo " id="T6:U624"><span class="mxinfo " id="T6:U625"><span class="var type1" id="S82T2U870">miu_svi_sviT</span> (<span class="mxinfo " id="T21:U627">:</span>, <span class="mxinfo " id="T21:U628">:</span>, <span class="mxinfo " id="T3:U629"><span class="var type1" id="S34T3U873"><span class="potentialdiff PD3">i</span></span></span>)</span> =  <span class="mxinfo " id="T25:U630"><span class="var type1" id="S80T25U875">miu_sv_svT_all</span> ( <span class="mxinfo " id="T39:U632">(<span class="mxinfo " id="T3:U633"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U634">(<span class="mxinfo " id="T3:U635"><span class="var type1" id="S34T3U882">i</span>-<span class="mxinfo " id="T3:U637">1</span></span>)*<span class="var type1" id="S18T3U884">q</span></span>+<span class="mxinfo " id="T3:U639">1</span></span></span>) : <span class="var type1" id="S34T3U887">i</span>*<span class="var type1" id="S18T3U888">q</span></span> , <span class="mxinfo " id="T39:U642">(<span class="mxinfo " id="T3:U643"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U644">(<span class="mxinfo " id="T3:U645"><span class="var type1" id="S34T3U895">i</span>-<span class="mxinfo " id="T3:U647">1</span></span>)*<span class="var type1" id="S18T3U897">q</span></span>+<span class="mxinfo " id="T3:U649">1</span></span></span>) : <span class="var type1" id="S34T3U900">i</span>*<span class="var type1" id="S18T3U901">q</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">        <span class="mxinfo " id="T6:U652"><span class="mxinfo " id="T6:U653"><span class="var type1" id="S83T2U905">miu_svi_svT</span>  (<span class="mxinfo " id="T21:U655">:</span>, <span class="mxinfo " id="T21:U656">:</span>, <span class="mxinfo " id="T3:U657"><span class="var type1" id="S34T3U908"><span class="potentialdiff PD3">i</span></span></span>)</span> =  <span class="mxinfo " id="T25:U658"><span class="var type1" id="S80T25U910">miu_sv_svT_all</span> ( <span class="mxinfo " id="T39:U660">(<span class="mxinfo " id="T3:U661"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U662">(<span class="mxinfo " id="T3:U663"><span class="var type1" id="S34T3U917">i</span>-<span class="mxinfo " id="T3:U665">1</span></span>)*<span class="var type1" id="S18T3U919">q</span></span>+<span class="mxinfo " id="T3:U667">1</span></span></span>) : <span class="var type1" id="S34T3U922">i</span>*<span class="var type1" id="S18T3U923">q</span></span> , <span class="mxinfo " id="T39:U670">(<span class="mxinfo " id="T3:U671"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U672"><span class="var type1" id="S16T3U928">N</span>*<span class="var type1" id="S18T3U929">q</span></span>+<span class="mxinfo " id="T3:U675">1</span></span></span>): <span class="potentialdiff PD1">(<span class="mxinfo " id="T3:U676"><span class="var type1" id="S16T3U934">N</span>+<span class="mxinfo " id="T3:U678">1</span></span>)*<span class="var type1" id="S18T3U936">q</span></span></span>  )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">    <span class="mxinfo " id="T36:U680"><span class="var type1" id="S84T36U939">miu_sv</span>         =  <span class="mxinfo " id="T36:U682"><span class="var type1" id="S79T36U941">miu_sv_all</span>     ( <span class="mxinfo " id="T39:U684">(<span class="mxinfo " id="T3:U685"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U686"><span class="var type1" id="S16T3U946">N</span>*<span class="var type1" id="S18T3U947">q</span></span>+<span class="mxinfo " id="T3:U689">1</span></span></span>) : <span class="potentialdiff PD1">(<span class="mxinfo " id="T3:U690"><span class="var type1" id="S16T3U952">N</span>+<span class="mxinfo " id="T3:U692">1</span></span>)*<span class="var type1" id="S18T3U954">q</span></span></span> , <span class="mxinfo " id="T38:U694">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">    <span class="mxinfo " id="T25:U695"><span class="var type1" id="S85T25U958">miu_sv_svT</span>     =  <span class="mxinfo " id="T25:U697"><span class="var type1" id="S80T25U960">miu_sv_svT_all</span> ( <span class="mxinfo " id="T39:U699">(<span class="mxinfo " id="T3:U700"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U701"><span class="var type1" id="S16T3U965">N</span>*<span class="var type1" id="S18T3U966">q</span></span>+<span class="mxinfo " id="T3:U704">1</span></span></span>) : <span class="potentialdiff PD1">(<span class="mxinfo " id="T3:U705"><span class="var type1" id="S16T3U971">N</span>+<span class="mxinfo " id="T3:U707">1</span></span>)*<span class="var type1" id="S18T3U973">q</span></span></span> , <span class="mxinfo " id="T39:U709">(<span class="mxinfo " id="T3:U710"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U711"><span class="var type1" id="S16T3U978">N</span>*<span class="var type1" id="S18T3U979">q</span></span>+<span class="mxinfo " id="T3:U714">1</span></span></span>): <span class="potentialdiff PD1">(<span class="mxinfo " id="T3:U715"><span class="var type1" id="S16T3U984">N</span>+<span class="mxinfo " id="T3:U717">1</span></span>)*<span class="var type1" id="S18T3U986">q</span></span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line">    <span class="comment">%clear miu_sv_all miu_sv_svT_all;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">    <span class="mxinfo " id="T6:U719"><span class="mxinfo " id="T6:U720"><span class="var type1" id="S5T2U990">subICmean</span>(<span class="mxinfo " id="T21:U722">:</span>,<span class="mxinfo " id="T21:U723">:</span>,<span class="mxinfo " id="T3:U724"><span class="var type1" id="S48T3U993"><span class="potentialdiff PD3">v</span></span></span>)</span> = <span class="mxinfo " id="T6:U725">squeeze(<span class="var type1" id="S81T32U996">miu_svi</span>)</span></span>; <span class="comment">% E(si(v) | Y(v), theta)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line">    <span class="mxinfo " id="T2:U727"><span class="mxinfo " id="T2:U728"><span class="var type1" id="S6T5U1000">subICvar</span>(<span class="mxinfo " id="T21:U730">:</span>,<span class="mxinfo " id="T21:U731">:</span>,<span class="mxinfo " id="T21:U732">:</span>,<span class="mxinfo " id="T3:U733"><span class="var type1" id="S48T3U1004"><span class="potentialdiff PD3">v</span></span></span>)</span> = <span class="var type1" id="S82T2U1005">miu_svi_sviT</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line">    <span class="mxinfo " id="T4:U735"><span class="mxinfo " id="T4:U736"><span class="var type1" id="S7T6U1009">grpICmean</span>(<span class="mxinfo " id="T21:U738">:</span>,<span class="mxinfo " id="T3:U739"><span class="var type1" id="S48T3U1011"><span class="potentialdiff PD3">v</span></span></span>)</span> = <span class="var type1" id="S84T36U1012">miu_sv</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">    <span class="mxinfo " id="T6:U741"><span class="mxinfo " id="T6:U742"><span class="var type1" id="S8T2U1016">grpICvar</span>(<span class="mxinfo " id="T21:U744">:</span>,<span class="mxinfo " id="T21:U745">:</span>,<span class="mxinfo " id="T3:U746"><span class="var type1" id="S48T3U1019"><span class="potentialdiff PD3">v</span></span></span>)</span> = <span class="var type1" id="S85T25U1020">miu_sv_svT</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">    <span class="mxinfo " id="T2:U748"><span class="var type1" id="S87T2U1023">mtSum</span> = <span class="mxinfo " id="T2:U750">zeros(<span class="mxinfo " id="T3:U751"><span class="var type1" id="S17T3U1026"><span class="potentialdiff PD1">T</span></span></span>,<span class="mxinfo " id="T3:U752"><span class="var type1" id="S18T3U1027"><span class="potentialdiff PD1">q</span></span></span>,<span class="mxinfo " id="T3:U753"><span class="var type1" id="S16T3U1028"><span class="potentialdiff PD1">N</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line">    <span class="comment">% E(si(v) | Y(v), theta)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">    <span class="mxinfo " id="T2:U754"><span class="var type1" id="S87T2U1031">mtSum</span> =  <span class="mxinfo " id="T40:U756"><span class="extrinsicFcn" id="F1329N8:B1033">mtimesx</span>(<span class="mxinfo " id="T41:U757">reshape(<span class="mxinfo " id="T29:U758"><span class="var type1" id="S11T7U1037">Y</span>(<span class="mxinfo " id="T30:U760">:</span>,<span class="var type1" id="S48T3U1039">v</span>)</span>,<span class="var type1" id="S18T3U1040">q</span>,1,[])</span>,<span class="mxinfo " id="T42:U763">permute(<span class="var type1" id="S81T32U1046">miu_svi</span>,[2,1,3])</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">    <span class="mxinfo " id="T2:U765"><span class="var type1" id="S24T2U1054">A_ProdPart1</span> = <span class="mxinfo " id="T2:U767"><span class="potentialdiff PD5"><span class="var type1" id="S24T2U1056">A_ProdPart1</span> + <span class="var type1" id="S87T2U1057">mtSum</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">    <span class="mxinfo " id="T2:U770"><span class="var type1" id="S25T2U1060">A_ProdPart2</span> = <span class="mxinfo " id="T2:U772"><span class="potentialdiff PD5"><span class="var type1" id="S25T2U1062">A_ProdPart2</span> + <span class="var type1" id="S82T2U1063">miu_svi_sviT</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">    <span class="comment">%beta_new(:,:,v) = beta_new(:,:,v) + mtimesx(X_mtx, permute((bsxfun(@minus, miu_svi, miu_sv)),[2,1,3]));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U1066">i</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U776">1</span>:<span class="var type1" id="S16T3U1069">N</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">        <span class="mxinfo " id="T6:U778"><span class="mxinfo " id="T6:U779"><span class="var type1" id="S3T2U1073">beta_new</span>(<span class="mxinfo " id="T21:U781">:</span>,<span class="mxinfo " id="T21:U782">:</span>,<span class="mxinfo " id="T3:U783"><span class="var type1" id="S48T3U1076"><span class="potentialdiff PD3">v</span></span></span>)</span>    = <span class="mxinfo " id="T43:U784"><span class="potentialdiff PD5"><span class="mxinfo " id="T6:U785"><span class="var type1" id="S3T2U1079">beta_new</span>(<span class="mxinfo " id="T21:U787">:</span>,<span class="mxinfo " id="T21:U788">:</span>,<span class="var type1" id="S48T3U1082">v</span>)</span>    + <span class="mxinfo " id="T43:U790"><span class="mxinfo " id="T44:U791"><span class="var type1" id="S12T8U1085">X_mtx</span>(<span class="mxinfo " id="T28:U793">:</span>,<span class="var type1" id="S34T3U1087">i</span>)</span>*<span class="mxinfo " id="T37:U795">(<span class="mxinfo " id="T36:U796"><span class="potentialdiff PD5"><span class="mxinfo " id="T4:U797"><span class="var type1" id="S81T32U1092">miu_svi</span>(<span class="mxinfo " id="T21:U799">:</span>,<span class="mxinfo " id="T38:U800">:</span>,<span class="var type1" id="S34T3U1095">i</span>)</span> - <span class="var type1" id="S84T36U1096">miu_sv</span></span></span>)'</span></span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">    <span class="comment">%weighting \sum(XiXiT)^{-1}, similar to the design matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">    <span class="comment">%----------------------- Update beta at each voxel ----------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">    <span class="mxinfo " id="T6:U803"><span class="mxinfo " id="T6:U804"><span class="var type1" id="S3T2U1100">beta_new</span>(<span class="mxinfo " id="T21:U806">:</span>,<span class="mxinfo " id="T21:U807">:</span>,<span class="mxinfo " id="T3:U808"><span class="var type1" id="S48T3U1103"><span class="potentialdiff PD3">v</span></span></span>)</span>    = <span class="mxinfo " id="T6:U809"><span class="potentialdiff PD4"><span class="var type1" id="S30T16U1105">sumXiXiT_inv</span> * <span class="mxinfo " id="T6:U811"><span class="var type1" id="S3T2U1107">beta_new</span>(<span class="mxinfo " id="T21:U813">:</span>,<span class="mxinfo " id="T21:U814">:</span>,<span class="var type1" id="S48T3U1110">v</span>)</span></span></span></span>;  <span class="comment">% new beta(v), coefficient matrix at voxel v</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    <span class="comment">%%% Update for sigma2 requires beta_new</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    <span class="comment">%sigma2_sq_all_V(:,:,v) = sum(miu_svi_sviT,3) + miu_sv_svT -2*sum(miu_svi_svT,3) <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">    <span class="comment">%    + 2*sum(mtimesx(bsxfun(@minus,miu_sv,miu_svi),X_mtx'*beta_new(:,:,v)),3) <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line">    <span class="comment">%    + beta_new(:,:,v)'* X_mtx * X_mtx'*beta_new(:,:,v);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U1113">i</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U817">1</span>:<span class="var type1" id="S16T3U1116">N</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">        <span class="comment">%  XXX + <span class="keyword">...</span><span class="comment">... 2(XXX - E(si(v) | Y(v), theta)) * ...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">        <span class="mxinfo " id="T6:U819"><span class="mxinfo " id="T6:U820"><span class="var type1" id="S26T2U1120">sigma2_sq_all_V</span>(<span class="mxinfo " id="T21:U822">:</span>,<span class="mxinfo " id="T21:U823">:</span>,<span class="mxinfo " id="T3:U824"><span class="var type1" id="S48T3U1123"><span class="potentialdiff PD3">v</span></span></span>)</span> = <span class="mxinfo " id="T25:U825"><span class="potentialdiff PD5"><span class="mxinfo " id="T25:U826"><span class="potentialdiff PD5"><span class="mxinfo " id="T25:U827"><span class="potentialdiff PD5"><span class="mxinfo " id="T25:U828"><span class="potentialdiff PD5"><span class="mxinfo " id="T6:U829"><span class="potentialdiff PD5"><span class="mxinfo " id="T6:U830"><span class="var type1" id="S26T2U1130">sigma2_sq_all_V</span>(<span class="mxinfo " id="T21:U832">:</span>,<span class="mxinfo " id="T21:U833">:</span>,<span class="var type1" id="S48T3U1133">v</span>)</span> + <span class="mxinfo " id="T6:U835"><span class="var type1" id="S82T2U1135">miu_svi_sviT</span>(<span class="mxinfo " id="T21:U837">:</span>,<span class="mxinfo " id="T21:U838">:</span>,<span class="var type1" id="S34T3U1138">i</span>)</span></span></span> + <span class="var type1" id="S85T25U1139">miu_sv_svT</span></span></span> - <span class="mxinfo " id="T6:U841"><span class="mxinfo " id="T3:U842">2</span>*<span class="mxinfo " id="T6:U843"><span class="var type1" id="S83T2U1143">miu_svi_svT</span>(<span class="mxinfo " id="T21:U845">:</span>,<span class="mxinfo " id="T21:U846">:</span>,<span class="var type1" id="S34T3U1146">i</span>)</span></span></span></span> <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line">            + <span class="mxinfo " id="T25:U848"><span class="potentialdiff PD4"><span class="mxinfo " id="T45:U849"><span class="mxinfo " id="T36:U850">2*(<span class="mxinfo " id="T36:U851"><span class="potentialdiff PD5"><span class="var type1" id="S84T36U1153">miu_sv</span> - <span class="mxinfo " id="T4:U853"><span class="var type1" id="S81T32U1155">miu_svi</span>(<span class="mxinfo " id="T21:U855">:</span>,<span class="mxinfo " id="T38:U856">:</span>,<span class="var type1" id="S34T3U1158">i</span>)</span></span></span>)</span> * <span class="mxinfo " id="T46:U858"><span class="mxinfo " id="T44:U859"><span class="var type1" id="S12T8U1161">X_mtx</span>(<span class="mxinfo " id="T28:U861">:</span>,<span class="var type1" id="S34T3U1163">i</span>)</span>'</span></span>*<span class="mxinfo " id="T6:U863"><span class="var type1" id="S3T2U1165">beta_new</span>(<span class="mxinfo " id="T21:U865">:</span>,<span class="mxinfo " id="T21:U866">:</span>,<span class="var type1" id="S48T3U1168">v</span>)</span></span></span></span></span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line">            + <span class="mxinfo " id="T6:U868"><span class="potentialdiff PD4"><span class="mxinfo " id="T16:U869"><span class="mxinfo " id="T4:U870"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U871"><span class="mxinfo " id="T6:U872"><span class="var type1" id="S3T2U1174">beta_new</span>(<span class="mxinfo " id="T21:U874">:</span>,<span class="mxinfo " id="T21:U875">:</span>,<span class="var type1" id="S48T3U1177">v</span>)</span>'</span>*<span class="mxinfo " id="T44:U877"><span class="var type1" id="S12T8U1179">X_mtx</span>(<span class="mxinfo " id="T28:U879">:</span>,<span class="var type1" id="S34T3U1181">i</span>)</span></span></span> * <span class="mxinfo " id="T46:U881"><span class="mxinfo " id="T44:U882"><span class="var type1" id="S12T8U1184">X_mtx</span>(<span class="mxinfo " id="T28:U884">:</span>,<span class="var type1" id="S34T3U1186">i</span>)</span>'</span></span>*<span class="mxinfo " id="T6:U886"><span class="var type1" id="S3T2U1188">beta_new</span>(<span class="mxinfo " id="T21:U888">:</span>,<span class="mxinfo " id="T21:U889">:</span>,<span class="var type1" id="S48T3U1191">v</span>)</span></span></span></span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"><span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line"><span class="mxinfo " id="T6:U891"><span class="var type1" id="S90T6U1194">sigma2_sq_all</span> = <span class="mxinfo " id="T6:U893">sum(<span class="var type1" id="S26T2U1197">sigma2_sq_all_V</span>,3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line"><span class="mxinfo " id="T4:U895"><span class="mxinfo " id="T4:U896"><span class="var type1" id="S2T1U1202">theta_new</span>.sigma2_sq</span> = <span class="mxinfo " id="T4:U898"><span class="mxinfo " id="T3:U899"><span class="mxinfo " id="T3:U900">1</span>/(<span class="mxinfo " id="T3:U901"><span class="var type1" id="S16T3U1209">N</span>*<span class="var type1" id="S21T3U1210">V</span></span>)</span> * <span class="mxinfo " id="T4:U904"><span class="potentialdiff PD8">diag(<span class="var type1" id="S90T6U1213">sigma2_sq_all</span>)</span></span></span></span>;                        <span class="comment">% new sigma2_sq</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S91T3U1216">l</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U907">1</span>:<span class="var type1" id="S18T3U1219">q</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">        <span class="mxinfo " id="T4:U909"><span class="var type1" id="S92T4U1222">act</span> = <span class="mxinfo " id="T4:U911"><span class="potentialdiff PD9">find(<span class="mxinfo " id="T35:U912"><span class="var type1" id="S47T4U1226">VoxelIC</span> == <span class="var type1" id="S91T3U1227">l</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line">        <span class="mxinfo " id="T4:U915"><span class="var type1" id="S94T4U1230">nois</span> = <span class="mxinfo " id="T4:U917"><span class="potentialdiff PD9">find(<span class="mxinfo " id="T35:U918"><span class="var type1" id="S47T4U1234">VoxelIC</span> ~= <span class="var type1" id="S91T3U1235">l</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">        <span class="mxinfo " id="T3:U921"><span class="mxinfo " id="T3:U922"><span class="potentialdiff PD3"><span class="potentialdiff PD1"><span class="mxinfo " id="T4:U923"><span class="var type1" id="S2T1U1240">theta_new</span>.pi</span>(<span class="mxinfo " id="T3:U925"><span class="mxinfo " id="T3:U926">1</span>+<span class="mxinfo " id="T3:U927">(<span class="mxinfo " id="T3:U928"><span class="var type1" id="S91T3U1247">l</span>-<span class="mxinfo " id="T3:U930">1</span></span>)*<span class="var type1" id="S20T3U1249">m</span></span></span>)</span></span></span> =  <span class="mxinfo " id="T3:U932">(<span class="mxinfo " id="T3:U933"><span class="mxinfo " id="T3:U934">length(<span class="var type1" id="S92T4U1255">act</span>)</span>+<span class="mxinfo " id="T3:U936">1</span></span>)/(<span class="mxinfo " id="T3:U937"><span class="mxinfo " id="T3:U938"><span class="mxinfo " id="T3:U939">length(<span class="var type1" id="S94T4U1262">nois</span>)</span>+<span class="mxinfo " id="T3:U941">length(<span class="var type1" id="S92T4U1265">act</span>)</span></span>+<span class="mxinfo " id="T3:U943">1</span></span>)</span></span>; <span class="comment">%%%%% in case no activation is identified</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line">        <span class="mxinfo " id="T3:U944"><span class="mxinfo " id="T3:U945"><span class="potentialdiff PD3"><span class="potentialdiff PD1"><span class="mxinfo " id="T4:U946"><span class="var type1" id="S2T1U1271">theta_new</span>.pi</span>(<span class="mxinfo " id="T3:U948"><span class="mxinfo " id="T3:U949">2</span>+<span class="mxinfo " id="T3:U950">(<span class="mxinfo " id="T3:U951"><span class="var type1" id="S91T3U1278">l</span>-<span class="mxinfo " id="T3:U953">1</span></span>)*<span class="var type1" id="S20T3U1280">m</span></span></span>)</span></span></span> =  <span class="mxinfo " id="T3:U955"><span class="mxinfo " id="T3:U956">length(<span class="var type1" id="S94T4U1284">nois</span>)</span>/(<span class="mxinfo " id="T3:U958"><span class="mxinfo " id="T3:U959"><span class="mxinfo " id="T3:U960">length(<span class="var type1" id="S94T4U1290">nois</span>)</span>+<span class="mxinfo " id="T3:U962">length(<span class="var type1" id="S92T4U1293">act</span>)</span></span>+<span class="mxinfo " id="T3:U964">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line">        <span class="mxinfo " id="T3:U965"><span class="mxinfo " id="T3:U966"><span class="potentialdiff PD3"><span class="potentialdiff PD1"><span class="mxinfo " id="T4:U967"><span class="var type1" id="S2T1U1299">theta_new</span>.miu3</span>(<span class="mxinfo " id="T3:U969"><span class="mxinfo " id="T3:U970">1</span>+<span class="mxinfo " id="T3:U971">(<span class="mxinfo " id="T3:U972"><span class="var type1" id="S91T3U1306">l</span>-<span class="mxinfo " id="T3:U974">1</span></span>)*<span class="var type1" id="S20T3U1308">m</span></span></span>)</span></span></span> = <span class="mxinfo " id="T3:U976"><span class="potentialdiff PD6">mean(<span class="mxinfo " id="T39:U977"><span class="var type1" id="S7T6U1312">grpICmean</span>(<span class="var type1" id="S91T3U1313">l</span>, <span class="var type1" id="S92T4U1314">act</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line">        <span class="mxinfo " id="T3:U981"><span class="mxinfo " id="T3:U982"><span class="potentialdiff PD3"><span class="potentialdiff PD1"><span class="mxinfo " id="T4:U983"><span class="var type1" id="S2T1U1319">theta_new</span>.miu3</span>(<span class="mxinfo " id="T3:U985"><span class="mxinfo " id="T3:U986">2</span>+<span class="mxinfo " id="T3:U987">(<span class="mxinfo " id="T3:U988"><span class="var type1" id="S91T3U1326">l</span>-<span class="mxinfo " id="T3:U990">1</span></span>)*<span class="var type1" id="S20T3U1328">m</span></span></span>)</span></span></span> = <span class="mxinfo " id="T3:U992"><span class="potentialdiff PD6">mean(<span class="mxinfo " id="T39:U993"><span class="var type1" id="S7T6U1332">grpICmean</span>(<span class="var type1" id="S91T3U1333">l</span>, <span class="var type1" id="S94T4U1334">nois</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line">        <span class="mxinfo " id="T3:U997"><span class="mxinfo " id="T3:U998"><span class="potentialdiff PD3"><span class="potentialdiff PD1"><span class="mxinfo " id="T4:U999"><span class="var type1" id="S2T1U1339">theta_new</span>.sigma3_sq</span>(<span class="mxinfo " id="T3:U1001"><span class="mxinfo " id="T3:U1002">1</span> +<span class="mxinfo " id="T3:U1003">(<span class="mxinfo " id="T3:U1004"><span class="var type1" id="S91T3U1346">l</span>-<span class="mxinfo " id="T3:U1006">1</span></span>)*<span class="var type1" id="S20T3U1348">m</span></span></span>)</span></span></span> = <span class="mxinfo " id="T3:U1008"><span class="potentialdiff PD6">mean(<span class="mxinfo " id="T47:U1009"><span class="var type1" id="S8T2U1352">grpICvar</span>(<span class="var type1" id="S91T3U1353">l</span>,<span class="var type1" id="S91T3U1354">l</span>,<span class="var type1" id="S92T4U1355">act</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line">        <span class="mxinfo " id="T3:U1014"><span class="mxinfo " id="T3:U1015"><span class="potentialdiff PD3"><span class="potentialdiff PD1"><span class="mxinfo " id="T4:U1016"><span class="var type1" id="S2T1U1360">theta_new</span>.sigma3_sq</span>(<span class="mxinfo " id="T3:U1018"><span class="mxinfo " id="T3:U1019">2</span> +<span class="mxinfo " id="T3:U1020">(<span class="mxinfo " id="T3:U1021"><span class="var type1" id="S91T3U1367">l</span>-<span class="mxinfo " id="T3:U1023">1</span></span>)*<span class="var type1" id="S20T3U1369">m</span></span></span>)</span></span></span> = <span class="mxinfo " id="T3:U1025"><span class="potentialdiff PD6">mean(<span class="mxinfo " id="T47:U1026"><span class="var type1" id="S8T2U1373">grpICvar</span>(<span class="var type1" id="S91T3U1374">l</span>,<span class="var type1" id="S91T3U1375">l</span>,<span class="var type1" id="S94T4U1376">nois</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line"><span class="mxinfo " id="T4:U1031"><span class="mxinfo " id="T4:U1032"><span class="var type1" id="S2T1U1380">theta_new</span>.sigma3_sq</span> = <span class="mxinfo " id="T4:U1034"><span class="potentialdiff PD5"><span class="mxinfo " id="T4:U1035"><span class="var type1" id="S2T1U1384">theta_new</span>.sigma3_sq</span> - <span class="mxinfo " id="T4:U1037"><span class="potentialdiff PD7"><span class="mxinfo " id="T4:U1038"><span class="var type1" id="S2T1U1388">theta_new</span>.miu3</span>.^2</span></span></span></span></span>;     <span class="comment">% new sigma3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line"><span class="comment">%%%% Handle NaN in previous iteration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line"><span class="mxinfo " id="T4:U1040"><span class="var type1" id="S97T4U1393">nanid</span> = <span class="mxinfo " id="T4:U1042"><span class="potentialdiff PD9">find(<span class="mxinfo " id="T35:U1043">isnan(<span class="mxinfo " id="T4:U1044"><span class="var type1" id="S2T1U1399">theta_new</span>.miu3</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T34:U1046">~<span class="mxinfo " id="T34:U1047">isempty(<span class="var type1" id="S97T4U1406">nanid</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line">    <span class="mxinfo " id="T4:U1049"><span class="potentialdiff PD5"><span class="mxinfo " id="T4:U1050"><span class="mxinfo " id="T4:U1051"><span class="var type1" id="S2T1U1411">theta_new</span>.sigma3_sq</span>(<span class="mxinfo " id="T4:U1053"><span class="var type1" id="S97T4U1413"><span class="potentialdiff PD3">nanid</span></span></span>)</span> = <span class="mxinfo " id="T4:U1054"><span class="mxinfo " id="T10:U1055"><span class="var type1" id="S13T9U1416">theta</span>.sigma3_sq</span>(<span class="var type1" id="S97T4U1418">nanid</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line">    <span class="mxinfo " id="T4:U1058"><span class="potentialdiff PD5"><span class="mxinfo " id="T4:U1059"><span class="mxinfo " id="T4:U1060"><span class="var type1" id="S2T1U1423">theta_new</span>.miu3</span>(<span class="mxinfo " id="T4:U1062"><span class="var type1" id="S97T4U1425"><span class="potentialdiff PD3">nanid</span></span></span>)</span> = <span class="mxinfo " id="T4:U1063"><span class="mxinfo " id="T10:U1064"><span class="var type1" id="S13T9U1428">theta</span>.miu3</span>(<span class="var type1" id="S97T4U1430">nanid</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line"><span class="comment">% This is the code from approx non experimental</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S34T3U1433">i</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U1068">1</span>:<span class="var type1" id="S16T3U1436">N</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line">    <span class="mxinfo " id="T6:U1070"><span class="mxinfo " id="T6:U1071"><span class="mxinfo " id="T2:U1072"><span class="var type1" id="S2T1U1441">theta_new</span>.A</span>(<span class="mxinfo " id="T21:U1074">:</span>,<span class="mxinfo " id="T21:U1075">:</span>,<span class="mxinfo " id="T3:U1076"><span class="var type1" id="S34T3U1445"><span class="potentialdiff PD3">i</span></span></span>)</span> = <span class="mxinfo " id="T6:U1077"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U1078"><span class="var type1" id="S24T2U1448">A_ProdPart1</span>(<span class="mxinfo " id="T21:U1080">:</span>,<span class="mxinfo " id="T21:U1081">:</span>,<span class="var type1" id="S34T3U1451">i</span>)</span> * <span class="mxinfo " id="T6:U1083">inv(<span class="mxinfo " id="T6:U1084"><span class="var type1" id="S25T2U1455">A_ProdPart2</span>(<span class="mxinfo " id="T21:U1086">:</span>,<span class="mxinfo " id="T21:U1087">:</span>,<span class="var type1" id="S34T3U1458">i</span>)</span>)</span></span></span></span>;   <span class="comment">%new Ai</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line">     <span class="comment">% Symmetric orthogonalization. </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line">    <span class="mxinfo " id="T6:U1089"><span class="mxinfo " id="T6:U1090"><span class="mxinfo " id="T2:U1091"><span class="var type1" id="S2T1U1463">theta_new</span>.A</span>(<span class="mxinfo " id="T21:U1093">:</span>,<span class="mxinfo " id="T21:U1094">:</span>,<span class="mxinfo " id="T3:U1095"><span class="var type1" id="S34T3U1467"><span class="potentialdiff PD3">i</span></span></span>)</span> = <span class="mxinfo " id="T6:U1096"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U1097"><span class="mxinfo " id="T2:U1098"><span class="var type1" id="S2T1U1471">theta_new</span>.A</span>(<span class="mxinfo " id="T21:U1100">:</span>,<span class="mxinfo " id="T21:U1101">:</span>,<span class="var type1" id="S34T3U1475">i</span>)</span>*<span class="mxinfo " id="T6:U1103">real(<span class="mxinfo " id="T48:U1104"><span class="potentialdiff PD7"><span class="potentialdiff PD4">sqrtm(<span class="mxinfo " id="T6:U1105">inv(<span class="mxinfo " id="T6:U1106"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U1107"><span class="mxinfo " id="T6:U1108"><span class="mxinfo " id="T2:U1109"><span class="var type1" id="S2T1U1486">theta_new</span>.A</span>(<span class="mxinfo " id="T21:U1111">:</span>,<span class="mxinfo " id="T21:U1112">:</span>,<span class="var type1" id="S34T3U1490">i</span>)</span>'</span>*<span class="mxinfo " id="T6:U1114"><span class="mxinfo " id="T2:U1115"><span class="var type1" id="S2T1U1493">theta_new</span>.A</span>(<span class="mxinfo " id="T21:U1117">:</span>,<span class="mxinfo " id="T21:U1118">:</span>,<span class="var type1" id="S34T3U1497">i</span>)</span></span></span>)</span>)</span></span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line"><span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S48T3U1500">v</span>=<span class="potentialdiff PD2"><span class="mxinfo " id="T3:U1121">1</span>:<span class="var type1" id="S21T3U1503">V</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U1506">i</span> = <span class="potentialdiff PD2"><span class="mxinfo " id="T3:U1124">1</span>:<span class="var type1" id="S16T3U1509">N</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line">            <span class="mxinfo " id="T3:U1126"><span class="mxinfo " id="T3:U1127"><span class="var type1" id="S2T1U1513">theta_new</span>.sigma1_sq</span> = <span class="mxinfo " id="T3:U1129"><span class="mxinfo " id="T3:U1130"><span class="mxinfo " id="T3:U1131"><span class="mxinfo " id="T3:U1132"><span class="var type1" id="S2T1U1519">theta_new</span>.sigma1_sq</span> + <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line">            <span class="mxinfo " id="T3:U1134"><span class="potentialdiff PD4"><span class="mxinfo " id="T39:U1135"><span class="potentialdiff PD4"><span class="mxinfo " id="T23:U1136"><span class="mxinfo " id="T49:U1137"><span class="var type1" id="S11T7U1525">Y</span>(<span class="mxinfo " id="T23:U1139">(<span class="mxinfo " id="T3:U1140"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U1141"><span class="mxinfo " id="T3:U1142"><span class="var type1" id="S17T3U1531">T</span>*<span class="var type1" id="S34T3U1532">i</span></span>-<span class="var type1" id="S17T3U1533">T</span></span>+<span class="mxinfo " id="T3:U1146">1</span></span></span>):<span class="var type1" id="S17T3U1536">T</span>*<span class="var type1" id="S34T3U1537">i</span></span>,<span class="var type1" id="S48T3U1538">v</span>)</span>'</span>*<span class="mxinfo " id="T6:U1150">diag(<span class="mxinfo " id="T4:U1151"><span class="var type1" id="S33T6U1542">C_inv</span>(<span class="mxinfo " id="T21:U1153">:</span>,<span class="var type1" id="S34T3U1544">i</span>)</span>)</span></span></span>*<span class="mxinfo " id="T49:U1155"><span class="var type1" id="S11T7U1546">Y</span>(<span class="mxinfo " id="T23:U1157">(<span class="mxinfo " id="T3:U1158"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U1159"><span class="mxinfo " id="T3:U1160"><span class="var type1" id="S17T3U1552">T</span>*<span class="var type1" id="S34T3U1553">i</span></span>-<span class="var type1" id="S17T3U1554">T</span></span>+<span class="mxinfo " id="T3:U1164">1</span></span></span>):<span class="var type1" id="S17T3U1557">T</span>*<span class="var type1" id="S34T3U1558">i</span></span>,<span class="var type1" id="S48T3U1559">v</span>)</span></span></span></span>-<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line">            <span class="mxinfo " id="T3:U1168"><span class="potentialdiff PD4"><span class="mxinfo " id="T39:U1169"><span class="potentialdiff PD4"><span class="mxinfo " id="T39:U1170"><span class="potentialdiff PD4"><span class="mxinfo " id="T23:U1171"><span class="mxinfo " id="T3:U1172">2</span>*<span class="mxinfo " id="T23:U1173"><span class="mxinfo " id="T49:U1174"><span class="var type1" id="S11T7U1567">Y</span>(<span class="mxinfo " id="T23:U1176">(<span class="mxinfo " id="T3:U1177"><span class="potentialdiff PD1"><span class="mxinfo " id="T3:U1178"><span class="mxinfo " id="T3:U1179"><span class="var type1" id="S17T3U1573">T</span>*<span class="var type1" id="S34T3U1574">i</span></span>-<span class="var type1" id="S17T3U1575">T</span></span>+<span class="mxinfo " id="T3:U1183">1</span></span></span>):<span class="var type1" id="S17T3U1578">T</span>*<span class="var type1" id="S34T3U1579">i</span></span>,<span class="var type1" id="S48T3U1580">v</span>)</span>'</span></span>*<span class="mxinfo " id="T6:U1187">diag(<span class="mxinfo " id="T4:U1188"><span class="var type1" id="S33T6U1584">C_inv</span>(<span class="mxinfo " id="T21:U1190">:</span>,<span class="var type1" id="S34T3U1586">i</span>)</span>)</span></span></span>*<span class="mxinfo " id="T6:U1192"><span class="mxinfo " id="T2:U1193"><span class="var type1" id="S2T1U1589">theta_new</span>.A</span>(<span class="mxinfo " id="T21:U1195">:</span>,<span class="mxinfo " id="T21:U1196">:</span>,<span class="var type1" id="S34T3U1593">i</span>)</span></span></span> * <span class="mxinfo " id="T4:U1198"><span class="var type1" id="S5T2U1595">subICmean</span>(<span class="mxinfo " id="T21:U1200">:</span>,<span class="var type1" id="S34T3U1597">i</span>,<span class="var type1" id="S48T3U1598">v</span>)</span></span></span></span>+ <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line">            <span class="mxinfo " id="T3:U1203">trace( <span class="mxinfo " id="T6:U1204"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U1205"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U1206"><span class="potentialdiff PD4"><span class="mxinfo " id="T6:U1207"><span class="mxinfo " id="T6:U1208"><span class="mxinfo " id="T2:U1209"><span class="var type1" id="S2T1U1607">theta_new</span>.A</span>(<span class="mxinfo " id="T21:U1211">:</span>,<span class="mxinfo " id="T21:U1212">:</span>,<span class="var type1" id="S34T3U1611">i</span>)</span>'</span>*<span class="mxinfo " id="T6:U1214">diag(<span class="mxinfo " id="T4:U1215"><span class="var type1" id="S33T6U1615">C_inv</span>(<span class="mxinfo " id="T21:U1217">:</span>,<span class="var type1" id="S34T3U1617">i</span>)</span>)</span></span></span>* <span class="mxinfo " id="T6:U1219"><span class="mxinfo " id="T2:U1220"><span class="var type1" id="S2T1U1620">theta_new</span>.A</span>(<span class="mxinfo " id="T21:U1222">:</span>,<span class="mxinfo " id="T21:U1223">:</span>,<span class="var type1" id="S34T3U1624">i</span>)</span></span></span> * <span class="mxinfo " id="T6:U1225"><span class="var type1" id="S6T5U1626">subICvar</span>(<span class="mxinfo " id="T21:U1227">:</span>,<span class="mxinfo " id="T21:U1228">:</span>,<span class="var type1" id="S34T3U1629">i</span>,<span class="var type1" id="S48T3U1630">v</span>)</span></span></span> )</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line"><span class="mxinfo " id="T3:U1231"><span class="mxinfo " id="T3:U1232"><span class="var type1" id="S2T1U1634">theta_new</span>.sigma1_sq</span> = <span class="mxinfo " id="T3:U1234"><span class="mxinfo " id="T3:U1235"><span class="mxinfo " id="T3:U1236">1</span>/(<span class="mxinfo " id="T3:U1237"><span class="mxinfo " id="T3:U1238"><span class="var type1" id="S16T3U1642">N</span>*<span class="var type1" id="S17T3U1643">T</span></span>*<span class="var type1" id="S21T3U1644">V</span></span>)</span>*<span class="mxinfo " id="T3:U1242"><span class="var type1" id="S2T1U1646">theta_new</span>.sigma1_sq</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line"><span class="keyword">end</span>  <span class="comment">%%% end of function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line"></span></span>
</pre>
</body>
</html>
