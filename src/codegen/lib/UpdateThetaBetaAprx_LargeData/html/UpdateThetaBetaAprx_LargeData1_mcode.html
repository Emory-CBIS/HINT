<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">theta_new</span>, <span class="var type1" id="S3T2U4">beta_new</span>, <span class="var type1" id="S4T4U5">z_mode</span>, <span class="var type1" id="S5T2U6">subICmean</span>, <span class="var type1" id="S6T5U7">subICvar</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line">        <span class="var type1" id="S7T6U8">grpICmean</span>, <span class="var type1" id="S8T2U9">grpICvar</span>, <span class="var type1" id="S9T3U10">err</span>, <span class="var type1" id="S10T2U11">G_z_dict</span>] = UpdateThetaBetaAprx_LargeData (<span class="var type1" id="S11T7U14">Y</span>, <span class="var type1" id="S12T8U15">X_mtx</span>, <span class="var type1" id="S13T9U16">theta</span>, <span class="var type1" id="S14T13U17">C_matrix_diag</span>, <span class="var type1" id="S15T14U18">beta</span>, <span class="var type1" id="S16T3U19">N</span>, <span class="var type1" id="S17T3U20">T</span>, <span class="var type1" id="S18T3U21">q</span>, <span class="var type1" id="S19T3U22">p</span>, <span class="var type1" id="S20T3U23">m</span>, <span class="var type1" id="S21T3U24">V</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%[theta_new, beta_new] = UpdateThetaBeta (Y, X_mtx, theta, beta, N, T, q, p, m, V)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% After preprocessing, T=q</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% Y           :  Y(:,V)  individual i scan time T at voxel v,      TN*V</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">% X_mtx       :  X(i,k)  predictor k for individual i,             p*N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% beta        :  beta (k, l, v)  coefficients at voxel v,          p*q*V</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">% C_matrix_diag: diagnal elements of C_matrix; % C matrix is (q * N)x1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">% miu_svi     :  E(si(v) | Y(v), theta)                            q*1*N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">% miu_sv      :  E(s(v)  | Y(v), theta)                            q*1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">% miu_svi_sviT:  E(si(v)si(v)'| Y(v), theta)                       q*q*N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% miu_sv_svT  :  E(s(v)s(v)'  | Y(v), theta)                       q*q</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">% miu_sv_sviT :  E(s(v)si(v)' | Y(v), theta)                       q*q*N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% First calculate the conditional probability of ICs given the data and</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% latent sorce state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="keyword">global</span> <span class="var type0" id="S22T0U26">keeplist</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="mxinfo " id="T3:U21"><span class="var type1" id="S9T3U29">err</span>=<span class="mxinfo " id="T3:U23">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="mxinfo " id="T2:U24"><span class="mxinfo " id="T2:U25"><span class="var type1" id="S2T1U34">theta_new</span>.A</span>         = <span class="mxinfo " id="T2:U27">zeros(<span class="var type1" id="S17T3U38">T</span>, <span class="var type1" id="S18T3U39">q</span>, <span class="var type1" id="S16T3U40">N</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="mxinfo " id="T3:U31"><span class="mxinfo " id="T3:U32"><span class="var type1" id="S2T1U44">theta_new</span>.sigma1_sq</span> = <span class="mxinfo " id="T3:U34">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="mxinfo " id="T4:U35"><span class="mxinfo " id="T4:U36"><span class="var type1" id="S2T1U50">theta_new</span>.sigma2_sq</span> = <span class="mxinfo " id="T4:U38">zeros(<span class="var type1" id="S18T3U54">q</span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="mxinfo " id="T4:U40"><span class="mxinfo " id="T4:U41"><span class="var type1" id="S2T1U59">theta_new</span>.miu3</span>      = <span class="mxinfo " id="T4:U43">zeros(<span class="mxinfo " id="T3:U44"><span class="var type1" id="S20T3U64">m</span>*<span class="var type1" id="S18T3U65">q</span></span>, 1)</span></span>;   <span class="comment">%pi, miu3, sigma3 in the order of miul1,<span class="keyword">...</span><span class="comment">,miulm, l=1:q</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="mxinfo " id="T4:U47"><span class="mxinfo " id="T4:U48"><span class="var type1" id="S2T1U70">theta_new</span>.sigma3_sq</span> = <span class="mxinfo " id="T4:U50">zeros(<span class="mxinfo " id="T3:U51"><span class="var type1" id="S20T3U75">m</span>*<span class="var type1" id="S18T3U76">q</span></span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T4:U54"><span class="mxinfo " id="T4:U55"><span class="var type1" id="S2T1U81">theta_new</span>.pi</span>        = <span class="mxinfo " id="T4:U57">zeros(<span class="mxinfo " id="T3:U58"><span class="var type1" id="S20T3U86">m</span>*<span class="var type1" id="S18T3U87">q</span></span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo " id="T2:U61"><span class="var type1" id="S3T2U91">beta_new</span>            = <span class="mxinfo " id="T2:U63">zeros(<span class="var type1" id="S19T3U94">p</span>, <span class="var type1" id="S18T3U95">q</span>, <span class="var type1" id="S21T3U96">V</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="mxinfo " id="T2:U67"><span class="var type1" id="S24T2U99">A_ProdPart1</span>         = <span class="mxinfo " id="T2:U69">zeros(<span class="var type1" id="S17T3U102">T</span>, <span class="var type1" id="S18T3U103">q</span>, <span class="var type1" id="S16T3U104">N</span>)</span></span>;  <span class="comment">%first part of the product format for Ai</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="mxinfo " id="T2:U73"><span class="var type1" id="S25T2U107">A_ProdPart2</span>         = <span class="mxinfo " id="T2:U75">zeros(<span class="var type1" id="S18T3U110">q</span>, <span class="var type1" id="S18T3U111">q</span>, <span class="var type1" id="S16T3U112">N</span>)</span></span>;  <span class="comment">%second part of the product format for Ai</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">%sigma2_sq_all       = zeros(q, q);     %%% record all second level variance-covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo " id="T2:U79"><span class="var type1" id="S26T2U115">sigma2_sq_all_V</span>       = <span class="mxinfo " id="T2:U81">zeros(<span class="var type1" id="S18T3U118">q</span>, <span class="var type1" id="S18T3U119">q</span>, <span class="var type1" id="S21T3U120">V</span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">coder.extrinsic(<span class="string">'mvnpdf'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">coder.extrinsic(<span class="string">'mtimesx'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="mxinfo " id="T4:U85"><span class="var type1" id="S4T4U135">z_mode</span> = <span class="mxinfo " id="T4:U87">zeros(<span class="var type1" id="S21T3U138">V</span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="mxinfo " id="T4:U89"><span class="var type1" id="S28T4U142">X</span>  = <span class="mxinfo " id="T4:U91">reshape(<span class="var type1" id="S12T8U145">X_mtx</span>, <span class="mxinfo " id="T3:U93"><span class="var type1" id="S16T3U147">N</span>*<span class="var type1" id="S19T3U148">p</span></span>, 1)</span></span>; <span class="comment">%reshape by column</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="mxinfo " id="T15:U96"><span class="var type1" id="S30T15U152">sumXiXiT_inv</span>  = <span class="mxinfo " id="T15:U98"><span class="mxinfo " id="T6:U99">eye(<span class="var type1" id="S19T3U156">p</span>)</span>/(<span class="mxinfo " id="T16:U101"><span class="var type1" id="S12T8U159">X_mtx</span>*<span class="mxinfo " id="T17:U103"><span class="var type1" id="S12T8U161">X_mtx</span>'</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="mxinfo " id="T2:U105"><span class="var type1" id="S5T2U164">subICmean</span> = <span class="mxinfo " id="T2:U107">zeros(<span class="var type1" id="S18T3U167">q</span>, <span class="var type1" id="S16T3U168">N</span>, <span class="var type1" id="S21T3U169">V</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="mxinfo " id="T5:U111"><span class="var type1" id="S6T5U172">subICvar</span> = <span class="mxinfo " id="T5:U113">zeros(<span class="var type1" id="S18T3U175">q</span>, <span class="var type1" id="S18T3U176">q</span>, <span class="var type1" id="S16T3U177">N</span>, <span class="var type1" id="S21T3U178">V</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="mxinfo " id="T6:U118"><span class="var type1" id="S7T6U181">grpICmean</span> = <span class="mxinfo " id="T6:U120">zeros(<span class="var type1" id="S18T3U184">q</span>, <span class="var type1" id="S21T3U185">V</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="mxinfo " id="T2:U123"><span class="var type1" id="S8T2U188">grpICvar</span> = <span class="mxinfo " id="T2:U125">zeros(<span class="var type1" id="S18T3U191">q</span>, <span class="var type1" id="S18T3U192">q</span>, <span class="var type1" id="S21T3U193">V</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="mxinfo " id="T6:U129"><span class="var type1" id="S32T6U196">A</span>   = <span class="mxinfo " id="T6:U131">zeros(<span class="mxinfo " id="T3:U132"><span class="var type1" id="S16T3U200">N</span>*<span class="var type1" id="S17T3U201">T</span></span>, <span class="mxinfo " id="T3:U135"><span class="var type1" id="S16T3U203">N</span>*<span class="var type1" id="S18T3U204">q</span></span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="mxinfo " id="T6:U138"><span class="var type1" id="S33T6U207">C_inv</span> = <span class="mxinfo " id="T6:U140">zeros(<span class="var type1" id="S17T3U210">T</span>, <span class="var type1" id="S16T3U211">N</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S34T3U214">i</span> = <span class="mxinfo " id="T3:U144">1</span>:<span class="var type1" id="S16T3U217">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">    <span class="mxinfo " id="T6:U146"><span class="mxinfo " id="T6:U147"><span class="var type1" id="S32T6U221">A</span>( <span class="mxinfo " id="T4:U149"><span class="mxinfo " id="T3:U150"><span class="mxinfo " id="T3:U151">(<span class="mxinfo " id="T3:U152"><span class="var type1" id="S34T3U227">i</span>-<span class="mxinfo " id="T3:U154">1</span></span>)*<span class="var type1" id="S17T3U229">T</span></span>+1</span>:<span class="mxinfo " id="T3:U156">(<span class="var type1" id="S34T3U235">i</span>-1)*<span class="var type1" id="S17T3U237">T</span>+<span class="var type1" id="S17T3U238">T</span></span></span> , <span class="mxinfo " id="T4:U160"><span class="mxinfo " id="T3:U161"><span class="mxinfo " id="T3:U162">(<span class="mxinfo " id="T3:U163"><span class="var type1" id="S34T3U244">i</span>-<span class="mxinfo " id="T3:U165">1</span></span>)*<span class="var type1" id="S18T3U246">q</span></span>+1</span>:<span class="mxinfo " id="T3:U167">(<span class="var type1" id="S34T3U252">i</span>-1)*<span class="var type1" id="S18T3U254">q</span>+<span class="var type1" id="S18T3U255">q</span></span></span>)</span> = <span class="mxinfo " id="T18:U171"><span class="mxinfo " id="T12:U172"><span class="var type1" id="S13T9U258">theta</span>.A</span>(<span class="mxinfo " id="T19:U174">:</span>,<span class="mxinfo " id="T19:U175">:</span>,<span class="var type1" id="S34T3U262">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">    <span class="mxinfo " id="T4:U177"><span class="mxinfo " id="T4:U178"><span class="var type1" id="S33T6U266">C_inv</span>(<span class="mxinfo " id="T20:U180">:</span>,<span class="var type1" id="S34T3U268">i</span>)</span> = <span class="mxinfo " id="T21:U182">1./<span class="mxinfo " id="T21:U183"><span class="var type1" id="S14T13U272">C_matrix_diag</span>(<span class="mxinfo " id="T22:U185">(<span class="mxinfo " id="T3:U186"><span class="mxinfo " id="T3:U187"><span class="mxinfo " id="T3:U188"><span class="var type1" id="S17T3U278">T</span>*<span class="var type1" id="S34T3U279">i</span></span>-<span class="var type1" id="S17T3U280">T</span></span>+<span class="mxinfo " id="T3:U192">1</span></span>):<span class="var type1" id="S17T3U283">T</span>*<span class="var type1" id="S34T3U284">i</span></span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="mxinfo " id="T6:U195"><span class="var type1" id="S35T6U287">B</span>   =   <span class="mxinfo " id="T6:U197">kron(<span class="mxinfo " id="T4:U198">ones(<span class="var type1" id="S16T3U292">N</span>, 1)</span>, <span class="mxinfo " id="T6:U200">eye(<span class="var type1" id="S18T3U296">q</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">%W2  =   [A, A*B];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="mxinfo " id="T6:U202"><span class="var type1" id="S38T6U299">W2</span> = <span class="mxinfo " id="T6:U204">[<span class="mxinfo " id="T6:U205">eye(<span class="mxinfo " id="T3:U206"><span class="var type1" id="S16T3U305">N</span>*<span class="var type1" id="S18T3U306">q</span></span>)</span>, <span class="var type1" id="S35T6U307">B</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="mxinfo " id="T6:U210"><span class="var type1" id="S39T6U310">P</span>   =   <span class="mxinfo " id="T6:U212">[ <span class="mxinfo " id="T6:U213"><span class="mxinfo " id="T6:U214">eye(<span class="mxinfo " id="T3:U215"><span class="var type1" id="S16T3U316">N</span>*<span class="var type1" id="S18T3U317">q</span></span>)</span> , <span class="var type1" id="S35T6U318">B</span></span>; <span class="mxinfo " id="T6:U219"><span class="mxinfo " id="T6:U220">zeros(<span class="var type1" id="S18T3U322">q</span>, <span class="mxinfo " id="T3:U222"><span class="var type1" id="S16T3U324">N</span>*<span class="var type1" id="S18T3U325">q</span></span>)</span>, <span class="mxinfo " id="T6:U225">eye(<span class="var type1" id="S18T3U328">q</span>)</span></span> ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="mxinfo " id="T23:U227"><span class="var type1" id="S40T23U331">Sigma1</span>   =   <span class="mxinfo " id="T23:U229">diag(<span class="mxinfo " id="T13:U230"><span class="var type1" id="S14T13U335">C_matrix_diag</span>.*<span class="mxinfo " id="T3:U232"><span class="var type1" id="S13T9U337">theta</span>.sigma1_sq</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="mxinfo " id="T23:U234"><span class="var type1" id="S42T23U341">Sigma1_inv</span> = <span class="mxinfo " id="T23:U236">diag(<span class="mxinfo " id="T13:U237">1./<span class="mxinfo " id="T13:U238">diag(<span class="var type1" id="S40T23U348">Sigma1</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="mxinfo " id="T6:U240"><span class="var type1" id="S43T6U351">Sigma2</span>   =   <span class="mxinfo " id="T6:U242">kron(<span class="mxinfo " id="T6:U243">eye(<span class="var type1" id="S16T3U356">N</span>)</span>, <span class="mxinfo " id="T18:U245">diag(<span class="mxinfo " id="T11:U246"><span class="var type1" id="S13T9U360">theta</span>.sigma2_sq</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="mxinfo " id="T24:U248"><span class="var type1" id="S44T24U364">Sigma_gamma0</span>  =   <span class="mxinfo " id="T24:U250"><span class="mxinfo " id="T25:U251"><span class="mxinfo " id="T6:U252"><span class="var type1" id="S38T6U368">W2</span>'</span> * <span class="var type1" id="S42T23U369">Sigma1_inv</span></span> * <span class="var type1" id="S38T6U370">W2</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%%%%% dictionary for the z(v) s</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="mxinfo " id="T6:U256"><span class="var type1" id="S45T6U373">z_dict</span> = <span class="mxinfo " id="T6:U258">[<span class="mxinfo " id="T6:U259"><span class="mxinfo " id="T6:U260"><span class="mxinfo " id="T3:U261">2</span>*<span class="mxinfo " id="T6:U262">ones(<span class="var type1" id="S18T3U381">q</span>)</span></span>-<span class="mxinfo " id="T6:U264">eye(<span class="var type1" id="S18T3U384">q</span>)</span></span>, <span class="mxinfo " id="T4:U266"><span class="mxinfo " id="T3:U267">2</span>*<span class="mxinfo " id="T4:U268">ones(<span class="var type1" id="S18T3U389">q</span>, 1)</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="mxinfo " id="T2:U270"><span class="var type1" id="S10T2U393">G_z_dict</span> = <span class="mxinfo " id="T2:U272">zeros(<span class="var type1" id="S18T3U396">q</span>, <span class="mxinfo " id="T3:U274"><span class="var type1" id="S20T3U398">m</span>*<span class="var type1" id="S18T3U399">q</span></span>, <span class="mxinfo " id="T3:U277"><span class="var type1" id="S18T3U401">q</span>+<span class="mxinfo " id="T3:U279">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S34T3U405">i</span> = <span class="mxinfo " id="T3:U281">1</span>:(<span class="mxinfo " id="T3:U282"><span class="var type1" id="S18T3U410">q</span>+<span class="mxinfo " id="T3:U284">1</span></span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">    <span class="mxinfo " id="T6:U285"><span class="mxinfo " id="T6:U286"><span class="var type1" id="S10T2U415">G_z_dict</span>(<span class="mxinfo " id="T20:U288">:</span>,<span class="mxinfo " id="T20:U289">:</span>,<span class="var type1" id="S34T3U418">i</span>)</span> = <span class="mxinfo " id="T6:U291"><span class="fcn" id="F413N2:B420">G_zv_gen</span>(<span class="mxinfo " id="T4:U292"><span class="var type1" id="S45T6U422">z_dict</span>(<span class="mxinfo " id="T20:U294">:</span>,<span class="var type1" id="S34T3U424">i</span>)</span>, <span class="var type1" id="S20T3U425">m</span>, <span class="var type1" id="S18T3U426">q</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="mxinfo " id="T4:U298"><span class="var type1" id="S47T4U429">VoxelIC</span> = <span class="mxinfo " id="T4:U300">zeros(<span class="var type1" id="S21T3U432">V</span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="comment">%%% Main V loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S48T3U436">v</span> = <span class="mxinfo " id="T3:U303">1</span>:<span class="var type1" id="S21T3U439">V</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">    <span class="mxinfo " id="T26:U305"><span class="var type1" id="S49T26U442">beta_v</span> = <span class="mxinfo " id="T26:U307"><span class="var type1" id="S15T14U444">beta</span>(<span class="mxinfo " id="T27:U309">:</span>,<span class="mxinfo " id="T19:U310">:</span>,<span class="var type1" id="S48T3U447">v</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    <span class="comment">% E-Step: generating all moments for updating</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">    <span class="mxinfo " id="T28:U312"><span class="var type1" id="S50T28U450">Y_v</span>  = <span class="mxinfo " id="T28:U314"><span class="var type1" id="S11T7U452">Y</span>(<span class="mxinfo " id="T29:U316">:</span>, <span class="var type1" id="S48T3U454">v</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">    <span class="mxinfo " id="T6:U318"><span class="var type1" id="S51T6U457">Beta_v_trans</span> =    <span class="mxinfo " id="T6:U320">kron(<span class="mxinfo " id="T6:U321">eye(<span class="var type1" id="S16T3U462">N</span>)</span>, <span class="mxinfo " id="T30:U323"><span class="var type1" id="S49T26U464">beta_v</span>'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="mxinfo " id="T4:U325"><span class="var type1" id="S52T4U467">Probzv</span> =   <span class="mxinfo " id="T4:U327">zeros(<span class="mxinfo " id="T3:U328"><span class="var type1" id="S18T3U471">q</span>+<span class="mxinfo " id="T3:U330">1</span></span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    <span class="comment">% Save moments conditional on z_r</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">    <span class="mxinfo " id="T31:U331"><span class="var type1" id="S53T31U476">miu_sv_all_condz</span>     = <span class="mxinfo " id="T31:U333">zeros( <span class="mxinfo " id="T3:U334">(<span class="mxinfo " id="T3:U335"><span class="var type1" id="S16T3U482">N</span>+<span class="mxinfo " id="T3:U337">1</span></span>)*<span class="var type1" id="S18T3U484">q</span></span>,   <span class="mxinfo " id="T3:U339">1</span>,     <span class="mxinfo " id="T3:U340"><span class="var type1" id="S18T3U487">q</span>+<span class="mxinfo " id="T3:U342">1</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">    <span class="mxinfo " id="T2:U343"><span class="var type1" id="S54T2U491">miu_sv_svT_all_condz</span> = <span class="mxinfo " id="T2:U345">zeros( <span class="mxinfo " id="T3:U346">(<span class="mxinfo " id="T3:U347"><span class="var type1" id="S16T3U497">N</span>+<span class="mxinfo " id="T3:U349">1</span></span>)*<span class="var type1" id="S18T3U499">q</span></span>, <span class="mxinfo " id="T3:U351">(<span class="mxinfo " id="T3:U352"><span class="var type1" id="S16T3U503">N</span>+<span class="mxinfo " id="T3:U354">1</span></span>)*<span class="var type1" id="S18T3U505">q</span></span>,  <span class="mxinfo " id="T3:U356"><span class="var type1" id="S18T3U507">q</span>+<span class="mxinfo " id="T3:U358">1</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U511">i</span> = <span class="mxinfo " id="T3:U360">1</span>:(<span class="mxinfo " id="T3:U361"><span class="var type1" id="S18T3U516">q</span>+<span class="mxinfo " id="T3:U363">1</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">            <span class="comment">% Get the Z configuration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">            <span class="mxinfo " id="T6:U364"><span class="var type1" id="S55T6U520">G_z</span> = <span class="mxinfo " id="T6:U366"><span class="var type1" id="S10T2U522">G_z_dict</span>(<span class="mxinfo " id="T20:U368">:</span>,<span class="mxinfo " id="T20:U369">:</span>,<span class="var type1" id="S34T3U525">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">            <span class="mxinfo " id="T4:U371"><span class="var type1" id="S56T4U528">miu3z</span> = <span class="mxinfo " id="T4:U373"><span class="var type1" id="S55T6U530">G_z</span>*<span class="mxinfo " id="T10:U375"><span class="var type1" id="S13T9U532">theta</span>.miu3</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">            <span class="comment">% Calculate Y star</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">            <span class="mxinfo " id="T4:U377"><span class="var type1" id="S57T4U536">miu_temp</span> = <span class="mxinfo " id="T4:U379"><span class="mxinfo " id="T4:U380"><span class="var type1" id="S35T6U539">B</span>*<span class="var type1" id="S56T4U540">miu3z</span></span> + <span class="mxinfo " id="T4:U383"><span class="var type1" id="S51T6U542">Beta_v_trans</span>*<span class="var type1" id="S28T4U543">X</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">            <span class="mxinfo " id="T4:U386"><span class="var type1" id="S58T4U546">Y_star</span>   = <span class="mxinfo " id="T4:U388"><span class="mxinfo " id="T4:U389"><span class="mxinfo " id="T6:U390"><span class="var type1" id="S32T6U550">A</span>'</span>*<span class="var type1" id="S50T28U551">Y_v</span></span> - <span class="var type1" id="S57T4U552">miu_temp</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">         </span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">            <span class="comment">% Calculate weighted probability</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">            <span class="mxinfo " id="T6:U394"><span class="var type1" id="S59T6U555">Sigma3z</span>  = <span class="mxinfo " id="T6:U396">diag(<span class="mxinfo " id="T4:U397"><span class="var type1" id="S55T6U559">G_z</span> * <span class="mxinfo " id="T10:U399"><span class="var type1" id="S13T9U561">theta</span>.sigma3_sq</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">            <span class="mxinfo " id="T6:U401"><span class="var type1" id="S60T6U565">Sigma23z</span> = <span class="mxinfo " id="T6:U403">blkdiag(<span class="var type1" id="S43T6U568">Sigma2</span>, <span class="var type1" id="S59T6U569">Sigma3z</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">            <span class="mxinfo " id="T4:U406"><span class="var type1" id="S62T4U572">pi_z</span> = <span class="mxinfo " id="T4:U408"><span class="var type1" id="S55T6U574">G_z</span> * <span class="mxinfo " id="T10:U410"><span class="var type1" id="S13T9U576">theta</span>.pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">            <span class="mxinfo " id="T23:U412"><span class="var type1" id="S63T23U580">mvn_cov</span> = <span class="mxinfo " id="T23:U414"><span class="mxinfo " id="T6:U415"><span class="mxinfo " id="T6:U416"><span class="var type1" id="S38T6U584">W2</span>*<span class="var type1" id="S60T6U585">Sigma23z</span></span>*<span class="mxinfo " id="T6:U419"><span class="var type1" id="S38T6U587">W2</span>'</span></span> + <span class="var type1" id="S40T23U588">Sigma1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">            <span class="comment">%%%% Approximate the above probability by factorization</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">            <span class="mxinfo " id="T3:U422"><span class="mxinfo " id="T3:U423"><span class="var type1" id="S52T4U592">Probzv</span>(<span class="var type1" id="S34T3U593">i</span>)</span> = <span class="mxinfo " id="T32:U426"><span class="mxinfo " id="T3:U427">sum( <span class="mxinfo " id="T4:U428">log(<span class="var type1" id="S62T4U599">pi_z</span>)</span> )</span> +<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">                <span class="mxinfo " id="T32:U430">sum( <span class="mxinfo " id="T13:U431">log( <span class="mxinfo " id="T13:U432"><span class="mxinfo " id="T13:U433">normpdf(<span class="var type1" id="S58T4U607">Y_star</span>, 0, <span class="mxinfo " id="T13:U435">sqrt(<span class="mxinfo " id="T13:U436">diag(<span class="var type1" id="S63T23U613">mvn_cov</span>)</span>)</span>)</span>  + <span class="mxinfo " id="T3:U438">0.00000000000000000001</span></span>)</span> )</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">                                   </span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">            <span class="comment">%display('MOVE THIS OUT OF LOOP!!!')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">%             Sigma_gamma  = eye((N+1)*q)/(Sigma_gamma0 + diag(1./diag(Sigma23z)));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="comment">%             miu_gamma    = Sigma_gamma*W2'*Sigma1_inv*Y_star;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">%             miu_star     = P * miu_gamma + [miu_temp; miu3z ];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%             Sigma_star   = P * Sigma_gamma * P';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="comment">%             miu_sv_all_condz (:, :, i)     = miu_star;                          %store first order moments from this iteration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="comment">%             miu_sv_svT_all_condz (:, :, i) = miu_star*miu_star'+Sigma_star;     %store second order moments from this interation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">    <span class="keyword">end</span> <span class="comment">% end of loop of Z configurations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">    [<span class="var type1" id="S68T3U618">val</span>, <span class="var type1" id="S69T3U619">maxid</span>] = max(<span class="var type1" id="S52T4U622">Probzv</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="mxinfo " id="T3:U442"><span class="var type1" id="S71T3U625">brokenVoxels</span> = <span class="mxinfo " id="T3:U444">sum(<span class="mxinfo " id="T33:U445"><span class="mxinfo " id="T3:U446">sum( <span class="mxinfo " id="T34:U447"><span class="var type1" id="S52T4U632">Probzv</span> == <span class="mxinfo " id="T3:U449">0</span></span>)</span> == <span class="mxinfo " id="T3:U450"><span class="var type1" id="S18T3U635">q</span>+<span class="mxinfo " id="T3:U452">1</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    <span class="keyword">if</span> (<span class="var type1" id="S71T3U641">brokenVoxels</span> == 1)</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="mxinfo " id="T3:U454"><span class="var type1" id="S71T3U645">brokenVoxels</span> = <span class="mxinfo " id="T3:U456">sum(<span class="mxinfo " id="T33:U457"><span class="mxinfo " id="T3:U458">sum( <span class="mxinfo " id="T34:U459"><span class="var type1" id="S52T4U652">Probzv</span> == <span class="mxinfo " id="T3:U461">-<span class="mxinfo " id="T3:U462">Inf</span></span></span>)</span> == <span class="mxinfo " id="T3:U463"><span class="var type1" id="S18T3U657">q</span>+<span class="mxinfo " id="T3:U465">1</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    <span class="keyword">if</span> (<span class="var type1" id="S71T3U663">brokenVoxels</span> == 1)</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    <span class="mxinfo " id="T3:U467"><span class="mxinfo " id="T3:U468"><span class="var type1" id="S47T4U668">VoxelIC</span>(<span class="var type1" id="S48T3U669">v</span>)</span> = <span class="var type1" id="S69T3U670">maxid</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">    <span class="mxinfo " id="T3:U472"><span class="mxinfo " id="T3:U473"><span class="var type1" id="S4T4U674">z_mode</span>(<span class="var type1" id="S48T3U675">v</span>)</span> = <span class="var type1" id="S69T3U676">maxid</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">    <span class="keyword">if</span>( <span class="mxinfo " id="T33:U477"><span class="mxinfo " id="T3:U478">sum(<span class="mxinfo " id="T34:U479">isnan(<span class="var type1" id="S52T4U685">Probzv</span>)</span>)</span> &gt;<span class="mxinfo " id="T3:U481">0</span></span> )    <span class="comment">%%%%% Handling errors when evaluating mvnpdf</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">        <span class="mxinfo " id="T3:U482"><span class="var type1" id="S9T3U689">err</span> = <span class="mxinfo " id="T3:U484">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">        error(<span class="string">'error in calculate Pr(z(v) | Y(v), theta) !'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">    <span class="comment">%%% Calculate miu_sv_all_condz, miu_sv_svT_all_condz for the maxid</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">    <span class="mxinfo " id="T6:U485"><span class="var type1" id="S55T6U697">G_z</span> = <span class="mxinfo " id="T6:U487"><span class="var type1" id="S10T2U699">G_z_dict</span>(<span class="mxinfo " id="T20:U489">:</span>,<span class="mxinfo " id="T20:U490">:</span>,<span class="var type1" id="S69T3U702">maxid</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">    <span class="mxinfo " id="T4:U492"><span class="var type1" id="S56T4U705">miu3z</span> = <span class="mxinfo " id="T4:U494"><span class="var type1" id="S55T6U707">G_z</span>*<span class="mxinfo " id="T10:U496"><span class="var type1" id="S13T9U709">theta</span>.miu3</span></span></span>;  </span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo " id="T4:U498"><span class="var type1" id="S57T4U713">miu_temp</span> = <span class="mxinfo " id="T4:U500"><span class="mxinfo " id="T4:U501"><span class="var type1" id="S35T6U716">B</span>*<span class="var type1" id="S56T4U717">miu3z</span></span> + <span class="mxinfo " id="T4:U504"><span class="var type1" id="S51T6U719">Beta_v_trans</span>*<span class="var type1" id="S28T4U720">X</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    <span class="mxinfo " id="T4:U507"><span class="var type1" id="S58T4U723">Y_star</span>   = <span class="mxinfo " id="T4:U509"><span class="mxinfo " id="T4:U510"><span class="mxinfo " id="T6:U511"><span class="var type1" id="S32T6U727">A</span>'</span>*<span class="var type1" id="S50T28U728">Y_v</span></span> - <span class="var type1" id="S57T4U729">miu_temp</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">    <span class="comment">% Calculate weighted probability</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">    <span class="mxinfo " id="T6:U515"><span class="var type1" id="S59T6U732">Sigma3z</span>  = <span class="mxinfo " id="T6:U517">diag(<span class="mxinfo " id="T4:U518"><span class="var type1" id="S55T6U736">G_z</span> * <span class="mxinfo " id="T10:U520"><span class="var type1" id="S13T9U738">theta</span>.sigma3_sq</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">    <span class="mxinfo " id="T6:U522"><span class="var type1" id="S60T6U742">Sigma23z</span> = <span class="mxinfo " id="T6:U524">blkdiag(<span class="var type1" id="S43T6U745">Sigma2</span>, <span class="var type1" id="S59T6U746">Sigma3z</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">    <span class="comment">%display('MOVE THIS OUT OF LOOP!!!')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">    <span class="mxinfo " id="T24:U527"><span class="var type1" id="S75T24U749">Sigma_gamma</span>  = <span class="mxinfo " id="T24:U529"><span class="mxinfo " id="T6:U530">eye(<span class="mxinfo " id="T3:U531">(<span class="mxinfo " id="T3:U532"><span class="var type1" id="S16T3U756">N</span>+<span class="mxinfo " id="T3:U534">1</span></span>)*<span class="var type1" id="S18T3U758">q</span></span>)</span>/(<span class="mxinfo " id="T24:U536"><span class="var type1" id="S44T24U761">Sigma_gamma0</span> + <span class="mxinfo " id="T6:U538">diag(<span class="mxinfo " id="T4:U539">1./<span class="mxinfo " id="T4:U540">diag(<span class="var type1" id="S60T6U768">Sigma23z</span>)</span></span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">    <span class="mxinfo " id="T35:U542"><span class="var type1" id="S76T35U771">miu_gamma</span>    = <span class="mxinfo " id="T35:U544"><span class="mxinfo " id="T25:U545"><span class="mxinfo " id="T24:U546"><span class="var type1" id="S75T24U775">Sigma_gamma</span>*<span class="mxinfo " id="T6:U548"><span class="var type1" id="S38T6U777">W2</span>'</span></span>*<span class="var type1" id="S42T23U778">Sigma1_inv</span></span>*<span class="var type1" id="S58T4U779">Y_star</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">    <span class="mxinfo " id="T35:U552"><span class="var type1" id="S77T35U782">miu_star</span>     = <span class="mxinfo " id="T35:U554"><span class="mxinfo " id="T35:U555"><span class="var type1" id="S39T6U785">P</span> * <span class="var type1" id="S76T35U786">miu_gamma</span></span> + <span class="mxinfo " id="T4:U558">[<span class="var type1" id="S57T4U789">miu_temp</span>; <span class="var type1" id="S56T4U791">miu3z</span> ]</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">    <span class="mxinfo " id="T24:U561"><span class="var type1" id="S78T24U794">Sigma_star</span>   = <span class="mxinfo " id="T24:U563"><span class="mxinfo " id="T24:U564"><span class="var type1" id="S39T6U797">P</span> * <span class="var type1" id="S75T24U798">Sigma_gamma</span></span> * <span class="mxinfo " id="T6:U567"><span class="var type1" id="S39T6U800">P</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">    <span class="mxinfo " id="T35:U569"><span class="var type1" id="S79T35U803">miu_sv_all</span>     = <span class="var type1" id="S77T35U804">miu_star</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">    <span class="mxinfo " id="T24:U572"><span class="var type1" id="S80T24U807">miu_sv_svT_all</span> = <span class="mxinfo " id="T24:U574"><span class="mxinfo " id="T24:U575"><span class="var type1" id="S77T35U810">miu_star</span> * <span class="mxinfo " id="T36:U577"><span class="var type1" id="S77T35U812">miu_star</span>'</span></span>+<span class="var type1" id="S78T24U813">Sigma_star</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">    <span class="comment">%miu_sv_all     =  miu_sv_all_condz(:,:,maxid);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">   <span class="comment">% miu_sv_svT_all =  miu_sv_svT_all_condz(:,:,maxid);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">    <span class="comment">% E(si(v) | Y(v), theta)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">    <span class="mxinfo " id="T31:U580"><span class="var type1" id="S81T31U816">miu_svi</span>      = <span class="mxinfo " id="T31:U582">zeros(<span class="var type1" id="S18T3U819">q</span>, <span class="mxinfo " id="T3:U584">1</span>, <span class="var type1" id="S16T3U821">N</span>)</span></span>;   <span class="comment">%first order moments of si(v) for each subject</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">    <span class="mxinfo " id="T2:U586"><span class="var type1" id="S82T2U824">miu_svi_sviT</span> = <span class="mxinfo " id="T2:U588">zeros(<span class="var type1" id="S18T3U827">q</span>, <span class="var type1" id="S18T3U828">q</span>, <span class="var type1" id="S16T3U829">N</span>)</span></span>;   <span class="comment">%second order moments of si(v) for each subject</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">    <span class="mxinfo " id="T2:U592"><span class="var type1" id="S83T2U832">miu_svi_svT</span>  = <span class="mxinfo " id="T2:U594">zeros(<span class="var type1" id="S18T3U835">q</span>, <span class="var type1" id="S18T3U836">q</span>, <span class="var type1" id="S16T3U837">N</span>)</span></span>;   <span class="comment">%interactions between si(v) and s(v)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U840">i</span> = <span class="mxinfo " id="T3:U599">1</span>: <span class="var type1" id="S16T3U843">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">        <span class="comment">%E(si(v) | Y(v), theta) = </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">        <span class="mxinfo " id="T4:U601"><span class="mxinfo " id="T4:U602"><span class="var type1" id="S81T31U847">miu_svi</span>      (<span class="mxinfo " id="T20:U604">:</span>, <span class="mxinfo " id="T37:U605">:</span>, <span class="var type1" id="S34T3U850">i</span>)</span> =  <span class="mxinfo " id="T35:U607"><span class="var type1" id="S79T35U852">miu_sv_all</span>( <span class="mxinfo " id="T38:U609">(<span class="mxinfo " id="T3:U610"><span class="mxinfo " id="T3:U611">(<span class="mxinfo " id="T3:U612"><span class="var type1" id="S34T3U859">i</span>-<span class="mxinfo " id="T3:U614">1</span></span>)*<span class="var type1" id="S18T3U861">q</span></span>+<span class="mxinfo " id="T3:U616">1</span></span>) : <span class="var type1" id="S34T3U864">i</span>*<span class="var type1" id="S18T3U865">q</span></span> , <span class="mxinfo " id="T37:U619">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">        <span class="mxinfo " id="T6:U620"><span class="mxinfo " id="T6:U621"><span class="var type1" id="S82T2U870">miu_svi_sviT</span> (<span class="mxinfo " id="T20:U623">:</span>, <span class="mxinfo " id="T20:U624">:</span>, <span class="var type1" id="S34T3U873">i</span>)</span> =  <span class="mxinfo " id="T24:U626"><span class="var type1" id="S80T24U875">miu_sv_svT_all</span> ( <span class="mxinfo " id="T38:U628">(<span class="mxinfo " id="T3:U629"><span class="mxinfo " id="T3:U630">(<span class="mxinfo " id="T3:U631"><span class="var type1" id="S34T3U882">i</span>-<span class="mxinfo " id="T3:U633">1</span></span>)*<span class="var type1" id="S18T3U884">q</span></span>+<span class="mxinfo " id="T3:U635">1</span></span>) : <span class="var type1" id="S34T3U887">i</span>*<span class="var type1" id="S18T3U888">q</span></span> , <span class="mxinfo " id="T38:U638">(<span class="mxinfo " id="T3:U639"><span class="mxinfo " id="T3:U640">(<span class="mxinfo " id="T3:U641"><span class="var type1" id="S34T3U895">i</span>-<span class="mxinfo " id="T3:U643">1</span></span>)*<span class="var type1" id="S18T3U897">q</span></span>+<span class="mxinfo " id="T3:U645">1</span></span>) : <span class="var type1" id="S34T3U900">i</span>*<span class="var type1" id="S18T3U901">q</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">        <span class="mxinfo " id="T6:U648"><span class="mxinfo " id="T6:U649"><span class="var type1" id="S83T2U905">miu_svi_svT</span>  (<span class="mxinfo " id="T20:U651">:</span>, <span class="mxinfo " id="T20:U652">:</span>, <span class="var type1" id="S34T3U908">i</span>)</span> =  <span class="mxinfo " id="T24:U654"><span class="var type1" id="S80T24U910">miu_sv_svT_all</span> ( <span class="mxinfo " id="T38:U656">(<span class="mxinfo " id="T3:U657"><span class="mxinfo " id="T3:U658">(<span class="mxinfo " id="T3:U659"><span class="var type1" id="S34T3U917">i</span>-<span class="mxinfo " id="T3:U661">1</span></span>)*<span class="var type1" id="S18T3U919">q</span></span>+<span class="mxinfo " id="T3:U663">1</span></span>) : <span class="var type1" id="S34T3U922">i</span>*<span class="var type1" id="S18T3U923">q</span></span> , <span class="mxinfo " id="T38:U666">(<span class="mxinfo " id="T3:U667"><span class="mxinfo " id="T3:U668"><span class="var type1" id="S16T3U928">N</span>*<span class="var type1" id="S18T3U929">q</span></span>+<span class="mxinfo " id="T3:U671">1</span></span>): (<span class="mxinfo " id="T3:U672"><span class="var type1" id="S16T3U934">N</span>+<span class="mxinfo " id="T3:U674">1</span></span>)*<span class="var type1" id="S18T3U936">q</span></span>  )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">    <span class="mxinfo " id="T35:U676"><span class="var type1" id="S84T35U939">miu_sv</span>         =  <span class="mxinfo " id="T35:U678"><span class="var type1" id="S79T35U941">miu_sv_all</span>     ( <span class="mxinfo " id="T38:U680">(<span class="mxinfo " id="T3:U681"><span class="mxinfo " id="T3:U682"><span class="var type1" id="S16T3U946">N</span>*<span class="var type1" id="S18T3U947">q</span></span>+<span class="mxinfo " id="T3:U685">1</span></span>) : (<span class="mxinfo " id="T3:U686"><span class="var type1" id="S16T3U952">N</span>+<span class="mxinfo " id="T3:U688">1</span></span>)*<span class="var type1" id="S18T3U954">q</span></span> , <span class="mxinfo " id="T37:U690">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">    <span class="mxinfo " id="T24:U691"><span class="var type1" id="S85T24U958">miu_sv_svT</span>     =  <span class="mxinfo " id="T24:U693"><span class="var type1" id="S80T24U960">miu_sv_svT_all</span> ( <span class="mxinfo " id="T38:U695">(<span class="mxinfo " id="T3:U696"><span class="mxinfo " id="T3:U697"><span class="var type1" id="S16T3U965">N</span>*<span class="var type1" id="S18T3U966">q</span></span>+<span class="mxinfo " id="T3:U700">1</span></span>) : (<span class="mxinfo " id="T3:U701"><span class="var type1" id="S16T3U971">N</span>+<span class="mxinfo " id="T3:U703">1</span></span>)*<span class="var type1" id="S18T3U973">q</span></span> , <span class="mxinfo " id="T38:U705">(<span class="mxinfo " id="T3:U706"><span class="mxinfo " id="T3:U707"><span class="var type1" id="S16T3U978">N</span>*<span class="var type1" id="S18T3U979">q</span></span>+<span class="mxinfo " id="T3:U710">1</span></span>): (<span class="mxinfo " id="T3:U711"><span class="var type1" id="S16T3U984">N</span>+<span class="mxinfo " id="T3:U713">1</span></span>)*<span class="var type1" id="S18T3U986">q</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line">    <span class="comment">%clear miu_sv_all miu_sv_svT_all;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">    <span class="mxinfo " id="T6:U715"><span class="mxinfo " id="T6:U716"><span class="var type1" id="S5T2U990">subICmean</span>(<span class="mxinfo " id="T20:U718">:</span>,<span class="mxinfo " id="T20:U719">:</span>,<span class="var type1" id="S48T3U993">v</span>)</span> = <span class="mxinfo " id="T6:U721">squeeze(<span class="var type1" id="S81T31U996">miu_svi</span>)</span></span>; <span class="comment">% E(si(v) | Y(v), theta)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line">    <span class="mxinfo " id="T2:U723"><span class="mxinfo " id="T2:U724"><span class="var type1" id="S6T5U1000">subICvar</span>(<span class="mxinfo " id="T20:U726">:</span>,<span class="mxinfo " id="T20:U727">:</span>,<span class="mxinfo " id="T20:U728">:</span>,<span class="var type1" id="S48T3U1004">v</span>)</span> = <span class="var type1" id="S82T2U1005">miu_svi_sviT</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line">    <span class="mxinfo " id="T4:U731"><span class="mxinfo " id="T4:U732"><span class="var type1" id="S7T6U1009">grpICmean</span>(<span class="mxinfo " id="T20:U734">:</span>,<span class="var type1" id="S48T3U1011">v</span>)</span> = <span class="var type1" id="S84T35U1012">miu_sv</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">    <span class="mxinfo " id="T6:U737"><span class="mxinfo " id="T6:U738"><span class="var type1" id="S8T2U1016">grpICvar</span>(<span class="mxinfo " id="T20:U740">:</span>,<span class="mxinfo " id="T20:U741">:</span>,<span class="var type1" id="S48T3U1019">v</span>)</span> = <span class="var type1" id="S85T24U1020">miu_sv_svT</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">    <span class="mxinfo " id="T2:U744"><span class="var type1" id="S87T2U1023">mtSum</span> = <span class="mxinfo " id="T2:U746">zeros(<span class="var type1" id="S17T3U1026">T</span>,<span class="var type1" id="S18T3U1027">q</span>,<span class="var type1" id="S16T3U1028">N</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line">    <span class="comment">% E(si(v) | Y(v), theta)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">    <span class="mxinfo " id="T39:U750"><span class="var type1" id="S88T39U1031">Y_reshape</span> = <span class="mxinfo " id="T39:U752">reshape(<span class="mxinfo " id="T28:U753"><span class="var type1" id="S11T7U1035">Y</span>(<span class="mxinfo " id="T29:U755">:</span>,<span class="var type1" id="S48T3U1037">v</span>)</span>,<span class="var type1" id="S18T3U1038">q</span>,1,[])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">    <span class="mxinfo " id="T40:U758"><span class="var type1" id="S89T40U1044">miu_svi_trans</span> = <span class="mxinfo " id="T40:U760">permute(<span class="var type1" id="S81T31U1047">miu_svi</span>,[2,1,3])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">    <span class="mxinfo " id="T2:U762"><span class="var type1" id="S87T2U1055">mtSum</span> = <span class="mxinfo " id="T2:U764">zeros(<span class="var type1" id="S18T3U1058">q</span>,<span class="var type1" id="S18T3U1059">q</span>,<span class="var type1" id="S16T3U1060">N</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S91T3U1063">iSubj</span> = <span class="mxinfo " id="T3:U769">1</span>:<span class="var type1" id="S16T3U1066">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">        <span class="mxinfo " id="T6:U771"><span class="mxinfo " id="T6:U772"><span class="var type1" id="S87T2U1070">mtSum</span>(<span class="mxinfo " id="T20:U774">:</span>,<span class="mxinfo " id="T20:U775">:</span>,<span class="var type1" id="S91T3U1073">iSubj</span>)</span> = <span class="mxinfo " id="T6:U777"><span class="mxinfo " id="T4:U778"><span class="var type1" id="S88T39U1076">Y_reshape</span>(<span class="mxinfo " id="T20:U780">:</span>,<span class="mxinfo " id="T37:U781">:</span>,<span class="var type1" id="S91T3U1079">iSubj</span>)</span> * <span class="mxinfo " id="T38:U783"><span class="var type1" id="S89T40U1081">miu_svi_trans</span>(<span class="mxinfo " id="T41:U785">:</span>,<span class="mxinfo " id="T20:U786">:</span>,<span class="var type1" id="S91T3U1084">iSubj</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">   <span class="comment">% mtSum =  mtimesx(reshape(Y(:,v),q,1,[]),permute(miu_svi,[2,1,3]));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">    <span class="mxinfo " id="T2:U788"><span class="var type1" id="S24T2U1087">A_ProdPart1</span> = <span class="mxinfo " id="T2:U790"><span class="var type1" id="S24T2U1089">A_ProdPart1</span> + <span class="var type1" id="S87T2U1090">mtSum</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">    <span class="mxinfo " id="T2:U793"><span class="var type1" id="S25T2U1093">A_ProdPart2</span> = <span class="mxinfo " id="T2:U795"><span class="var type1" id="S25T2U1095">A_ProdPart2</span> + <span class="var type1" id="S82T2U1096">miu_svi_sviT</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">    <span class="comment">%beta_new(:,:,v) = beta_new(:,:,v) + mtimesx(X_mtx, permute((bsxfun(@minus, miu_svi, miu_sv)),[2,1,3]));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U1099">i</span> = <span class="mxinfo " id="T3:U799">1</span>:<span class="var type1" id="S16T3U1102">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">        <span class="mxinfo " id="T6:U801"><span class="mxinfo " id="T6:U802"><span class="var type1" id="S3T2U1106">beta_new</span>(<span class="mxinfo " id="T20:U804">:</span>,<span class="mxinfo " id="T20:U805">:</span>,<span class="var type1" id="S48T3U1109">v</span>)</span>    = <span class="mxinfo " id="T42:U807"><span class="mxinfo " id="T6:U808"><span class="var type1" id="S3T2U1112">beta_new</span>(<span class="mxinfo " id="T20:U810">:</span>,<span class="mxinfo " id="T20:U811">:</span>,<span class="var type1" id="S48T3U1115">v</span>)</span>    + <span class="mxinfo " id="T42:U813"><span class="mxinfo " id="T43:U814"><span class="var type1" id="S12T8U1118">X_mtx</span>(<span class="mxinfo " id="T27:U816">:</span>,<span class="var type1" id="S34T3U1120">i</span>)</span>*<span class="mxinfo " id="T36:U818">(<span class="mxinfo " id="T35:U819"><span class="mxinfo " id="T4:U820"><span class="var type1" id="S81T31U1125">miu_svi</span>(<span class="mxinfo " id="T20:U822">:</span>,<span class="mxinfo " id="T37:U823">:</span>,<span class="var type1" id="S34T3U1128">i</span>)</span> - <span class="var type1" id="S84T35U1129">miu_sv</span></span>)'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    <span class="comment">%weighting \sum(XiXiT)^{-1}, similar to the design matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">    <span class="comment">%----------------------- Update beta at each voxel ----------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line">    <span class="mxinfo " id="T6:U826"><span class="mxinfo " id="T6:U827"><span class="var type1" id="S3T2U1133">beta_new</span>(<span class="mxinfo " id="T20:U829">:</span>,<span class="mxinfo " id="T20:U830">:</span>,<span class="var type1" id="S48T3U1136">v</span>)</span>    = <span class="mxinfo " id="T6:U832"><span class="var type1" id="S30T15U1138">sumXiXiT_inv</span> * <span class="mxinfo " id="T6:U834"><span class="var type1" id="S3T2U1140">beta_new</span>(<span class="mxinfo " id="T20:U836">:</span>,<span class="mxinfo " id="T20:U837">:</span>,<span class="var type1" id="S48T3U1143">v</span>)</span></span></span>;  <span class="comment">% new beta(v), coefficient matrix at voxel v</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">    <span class="comment">%%% Update for sigma2 requires beta_new</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line">    <span class="comment">%sigma2_sq_all_V(:,:,v) = sum(miu_svi_sviT,3) + miu_sv_svT -2*sum(miu_svi_svT,3) <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line">    <span class="comment">%    + 2*sum(mtimesx(bsxfun(@minus,miu_sv,miu_svi),X_mtx'*beta_new(:,:,v)),3) <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line">    <span class="comment">%    + beta_new(:,:,v)'* X_mtx * X_mtx'*beta_new(:,:,v);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U1146">i</span> = <span class="mxinfo " id="T3:U840">1</span>:<span class="var type1" id="S16T3U1149">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line">        <span class="comment">%  XXX + <span class="keyword">...</span><span class="comment">... 2(XXX - E(si(v) | Y(v), theta)) * ...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">        <span class="mxinfo " id="T6:U842"><span class="mxinfo " id="T6:U843"><span class="var type1" id="S26T2U1153">sigma2_sq_all_V</span>(<span class="mxinfo " id="T20:U845">:</span>,<span class="mxinfo " id="T20:U846">:</span>,<span class="var type1" id="S48T3U1156">v</span>)</span> = <span class="mxinfo " id="T24:U848"><span class="mxinfo " id="T24:U849"><span class="mxinfo " id="T24:U850"><span class="mxinfo " id="T24:U851"><span class="mxinfo " id="T6:U852"><span class="mxinfo " id="T6:U853"><span class="var type1" id="S26T2U1163">sigma2_sq_all_V</span>(<span class="mxinfo " id="T20:U855">:</span>,<span class="mxinfo " id="T20:U856">:</span>,<span class="var type1" id="S48T3U1166">v</span>)</span> + <span class="mxinfo " id="T6:U858"><span class="var type1" id="S82T2U1168">miu_svi_sviT</span>(<span class="mxinfo " id="T20:U860">:</span>,<span class="mxinfo " id="T20:U861">:</span>,<span class="var type1" id="S34T3U1171">i</span>)</span></span> + <span class="var type1" id="S85T24U1172">miu_sv_svT</span></span> - <span class="mxinfo " id="T6:U864"><span class="mxinfo " id="T3:U865">2</span>*<span class="mxinfo " id="T6:U866"><span class="var type1" id="S83T2U1176">miu_svi_svT</span>(<span class="mxinfo " id="T20:U868">:</span>,<span class="mxinfo " id="T20:U869">:</span>,<span class="var type1" id="S34T3U1179">i</span>)</span></span></span> <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line">            + <span class="mxinfo " id="T24:U871"><span class="mxinfo " id="T44:U872"><span class="mxinfo " id="T35:U873">2*(<span class="mxinfo " id="T35:U874"><span class="var type1" id="S84T35U1186">miu_sv</span> - <span class="mxinfo " id="T4:U876"><span class="var type1" id="S81T31U1188">miu_svi</span>(<span class="mxinfo " id="T20:U878">:</span>,<span class="mxinfo " id="T37:U879">:</span>,<span class="var type1" id="S34T3U1191">i</span>)</span></span>)</span> * <span class="mxinfo " id="T45:U881"><span class="mxinfo " id="T43:U882"><span class="var type1" id="S12T8U1194">X_mtx</span>(<span class="mxinfo " id="T27:U884">:</span>,<span class="var type1" id="S34T3U1196">i</span>)</span>'</span></span>*<span class="mxinfo " id="T6:U886"><span class="var type1" id="S3T2U1198">beta_new</span>(<span class="mxinfo " id="T20:U888">:</span>,<span class="mxinfo " id="T20:U889">:</span>,<span class="var type1" id="S48T3U1201">v</span>)</span></span></span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line">            + <span class="mxinfo " id="T6:U891"><span class="mxinfo " id="T15:U892"><span class="mxinfo " id="T4:U893"><span class="mxinfo " id="T6:U894"><span class="mxinfo " id="T6:U895"><span class="var type1" id="S3T2U1207">beta_new</span>(<span class="mxinfo " id="T20:U897">:</span>,<span class="mxinfo " id="T20:U898">:</span>,<span class="var type1" id="S48T3U1210">v</span>)</span>'</span>*<span class="mxinfo " id="T43:U900"><span class="var type1" id="S12T8U1212">X_mtx</span>(<span class="mxinfo " id="T27:U902">:</span>,<span class="var type1" id="S34T3U1214">i</span>)</span></span> * <span class="mxinfo " id="T45:U904"><span class="mxinfo " id="T43:U905"><span class="var type1" id="S12T8U1217">X_mtx</span>(<span class="mxinfo " id="T27:U907">:</span>,<span class="var type1" id="S34T3U1219">i</span>)</span>'</span></span>*<span class="mxinfo " id="T6:U909"><span class="var type1" id="S3T2U1221">beta_new</span>(<span class="mxinfo " id="T20:U911">:</span>,<span class="mxinfo " id="T20:U912">:</span>,<span class="var type1" id="S48T3U1224">v</span>)</span></span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line"><span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line"><span class="mxinfo " id="T6:U914"><span class="var type1" id="S92T6U1227">sigma2_sq_all</span> = <span class="mxinfo " id="T6:U916">sum(<span class="var type1" id="S26T2U1230">sigma2_sq_all_V</span>,3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line"><span class="mxinfo " id="T4:U918"><span class="mxinfo " id="T4:U919"><span class="var type1" id="S2T1U1235">theta_new</span>.sigma2_sq</span> = <span class="mxinfo " id="T4:U921"><span class="mxinfo " id="T3:U922"><span class="mxinfo " id="T3:U923">1</span>/(<span class="mxinfo " id="T3:U924"><span class="var type1" id="S16T3U1242">N</span>*<span class="var type1" id="S21T3U1243">V</span></span>)</span> * <span class="mxinfo " id="T4:U927">diag(<span class="var type1" id="S92T6U1246">sigma2_sq_all</span>)</span></span></span>;                        <span class="comment">% new sigma2_sq</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S93T3U1249">l</span> = <span class="mxinfo " id="T3:U930">1</span>:<span class="var type1" id="S18T3U1252">q</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line">        <span class="mxinfo " id="T4:U932"><span class="var type1" id="S94T4U1255">act</span> = <span class="mxinfo " id="T4:U934">find(<span class="mxinfo " id="T34:U935"><span class="var type1" id="S47T4U1259">VoxelIC</span> == <span class="var type1" id="S93T3U1260">l</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line">        <span class="mxinfo " id="T4:U938"><span class="var type1" id="S96T4U1263">nois</span> = <span class="mxinfo " id="T4:U940">find(<span class="mxinfo " id="T34:U941"><span class="var type1" id="S47T4U1267">VoxelIC</span> ~= <span class="var type1" id="S93T3U1268">l</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line">        <span class="mxinfo " id="T3:U944"><span class="mxinfo " id="T3:U945"><span class="mxinfo " id="T4:U946"><span class="var type1" id="S2T1U1273">theta_new</span>.pi</span>(<span class="mxinfo " id="T3:U948"><span class="mxinfo " id="T3:U949">1</span>+<span class="mxinfo " id="T3:U950">(<span class="mxinfo " id="T3:U951"><span class="var type1" id="S93T3U1280">l</span>-<span class="mxinfo " id="T3:U953">1</span></span>)*<span class="var type1" id="S20T3U1282">m</span></span></span>)</span> =  <span class="mxinfo " id="T3:U955">(<span class="mxinfo " id="T3:U956"><span class="mxinfo " id="T3:U957">length(<span class="var type1" id="S94T4U1288">act</span>)</span>+<span class="mxinfo " id="T3:U959">1</span></span>)/(<span class="mxinfo " id="T3:U960"><span class="mxinfo " id="T3:U961"><span class="mxinfo " id="T3:U962">length(<span class="var type1" id="S96T4U1295">nois</span>)</span>+<span class="mxinfo " id="T3:U964">length(<span class="var type1" id="S94T4U1298">act</span>)</span></span>+<span class="mxinfo " id="T3:U966">1</span></span>)</span></span>; <span class="comment">%%%%% in case no activation is identified</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line">        <span class="mxinfo " id="T3:U967"><span class="mxinfo " id="T3:U968"><span class="mxinfo " id="T4:U969"><span class="var type1" id="S2T1U1304">theta_new</span>.pi</span>(<span class="mxinfo " id="T3:U971"><span class="mxinfo " id="T3:U972">2</span>+<span class="mxinfo " id="T3:U973">(<span class="mxinfo " id="T3:U974"><span class="var type1" id="S93T3U1311">l</span>-<span class="mxinfo " id="T3:U976">1</span></span>)*<span class="var type1" id="S20T3U1313">m</span></span></span>)</span> =  <span class="mxinfo " id="T3:U978"><span class="mxinfo " id="T3:U979">length(<span class="var type1" id="S96T4U1317">nois</span>)</span>/(<span class="mxinfo " id="T3:U981"><span class="mxinfo " id="T3:U982"><span class="mxinfo " id="T3:U983">length(<span class="var type1" id="S96T4U1323">nois</span>)</span>+<span class="mxinfo " id="T3:U985">length(<span class="var type1" id="S94T4U1326">act</span>)</span></span>+<span class="mxinfo " id="T3:U987">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line">        <span class="mxinfo " id="T3:U988"><span class="mxinfo " id="T3:U989"><span class="mxinfo " id="T4:U990"><span class="var type1" id="S2T1U1332">theta_new</span>.miu3</span>(<span class="mxinfo " id="T3:U992"><span class="mxinfo " id="T3:U993">1</span>+<span class="mxinfo " id="T3:U994">(<span class="mxinfo " id="T3:U995"><span class="var type1" id="S93T3U1339">l</span>-<span class="mxinfo " id="T3:U997">1</span></span>)*<span class="var type1" id="S20T3U1341">m</span></span></span>)</span> = <span class="mxinfo " id="T3:U999">mean(<span class="mxinfo " id="T38:U1000"><span class="var type1" id="S7T6U1345">grpICmean</span>(<span class="var type1" id="S93T3U1346">l</span>, <span class="var type1" id="S94T4U1347">act</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line">        <span class="mxinfo " id="T3:U1004"><span class="mxinfo " id="T3:U1005"><span class="mxinfo " id="T4:U1006"><span class="var type1" id="S2T1U1352">theta_new</span>.miu3</span>(<span class="mxinfo " id="T3:U1008"><span class="mxinfo " id="T3:U1009">2</span>+<span class="mxinfo " id="T3:U1010">(<span class="mxinfo " id="T3:U1011"><span class="var type1" id="S93T3U1359">l</span>-<span class="mxinfo " id="T3:U1013">1</span></span>)*<span class="var type1" id="S20T3U1361">m</span></span></span>)</span> = <span class="mxinfo " id="T3:U1015">mean(<span class="mxinfo " id="T38:U1016"><span class="var type1" id="S7T6U1365">grpICmean</span>(<span class="var type1" id="S93T3U1366">l</span>, <span class="var type1" id="S96T4U1367">nois</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line">        <span class="mxinfo " id="T3:U1020"><span class="mxinfo " id="T3:U1021"><span class="mxinfo " id="T4:U1022"><span class="var type1" id="S2T1U1372">theta_new</span>.sigma3_sq</span>(<span class="mxinfo " id="T3:U1024"><span class="mxinfo " id="T3:U1025">1</span> +<span class="mxinfo " id="T3:U1026">(<span class="mxinfo " id="T3:U1027"><span class="var type1" id="S93T3U1379">l</span>-<span class="mxinfo " id="T3:U1029">1</span></span>)*<span class="var type1" id="S20T3U1381">m</span></span></span>)</span> = <span class="mxinfo " id="T3:U1031">mean(<span class="mxinfo " id="T46:U1032"><span class="var type1" id="S8T2U1385">grpICvar</span>(<span class="var type1" id="S93T3U1386">l</span>,<span class="var type1" id="S93T3U1387">l</span>,<span class="var type1" id="S94T4U1388">act</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line">        <span class="mxinfo " id="T3:U1037"><span class="mxinfo " id="T3:U1038"><span class="mxinfo " id="T4:U1039"><span class="var type1" id="S2T1U1393">theta_new</span>.sigma3_sq</span>(<span class="mxinfo " id="T3:U1041"><span class="mxinfo " id="T3:U1042">2</span> +<span class="mxinfo " id="T3:U1043">(<span class="mxinfo " id="T3:U1044"><span class="var type1" id="S93T3U1400">l</span>-<span class="mxinfo " id="T3:U1046">1</span></span>)*<span class="var type1" id="S20T3U1402">m</span></span></span>)</span> = <span class="mxinfo " id="T3:U1048">mean(<span class="mxinfo " id="T46:U1049"><span class="var type1" id="S8T2U1406">grpICvar</span>(<span class="var type1" id="S93T3U1407">l</span>,<span class="var type1" id="S93T3U1408">l</span>,<span class="var type1" id="S96T4U1409">nois</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line"><span class="mxinfo " id="T4:U1054"><span class="mxinfo " id="T4:U1055"><span class="var type1" id="S2T1U1413">theta_new</span>.sigma3_sq</span> = <span class="mxinfo " id="T4:U1057"><span class="mxinfo " id="T4:U1058"><span class="var type1" id="S2T1U1417">theta_new</span>.sigma3_sq</span> - <span class="mxinfo " id="T4:U1060"><span class="mxinfo " id="T4:U1061"><span class="var type1" id="S2T1U1421">theta_new</span>.miu3</span>.^2</span></span></span>;     <span class="comment">% new sigma3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line"><span class="comment">%%%% Handle NaN in previous iteration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line"><span class="mxinfo " id="T4:U1063"><span class="var type1" id="S99T4U1426">nanid</span> = <span class="mxinfo " id="T4:U1065">find(<span class="mxinfo " id="T34:U1066">isnan(<span class="mxinfo " id="T4:U1067"><span class="var type1" id="S2T1U1432">theta_new</span>.miu3</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T33:U1069">~<span class="mxinfo " id="T33:U1070">isempty(<span class="var type1" id="S99T4U1439">nanid</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line">    <span class="mxinfo " id="T4:U1072"><span class="mxinfo " id="T4:U1073"><span class="mxinfo " id="T4:U1074"><span class="var type1" id="S2T1U1444">theta_new</span>.sigma3_sq</span>(<span class="var type1" id="S99T4U1446">nanid</span>)</span> = <span class="mxinfo " id="T4:U1077"><span class="mxinfo " id="T10:U1078"><span class="var type1" id="S13T9U1449">theta</span>.sigma3_sq</span>(<span class="var type1" id="S99T4U1451">nanid</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line">    <span class="mxinfo " id="T4:U1081"><span class="mxinfo " id="T4:U1082"><span class="mxinfo " id="T4:U1083"><span class="var type1" id="S2T1U1456">theta_new</span>.miu3</span>(<span class="var type1" id="S99T4U1458">nanid</span>)</span> = <span class="mxinfo " id="T4:U1086"><span class="mxinfo " id="T10:U1087"><span class="var type1" id="S13T9U1461">theta</span>.miu3</span>(<span class="var type1" id="S99T4U1463">nanid</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line"><span class="comment">% This is the code from approx non experimental</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S34T3U1466">i</span> = <span class="mxinfo " id="T3:U1091">1</span>:<span class="var type1" id="S16T3U1469">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line">    <span class="mxinfo " id="T6:U1093"><span class="mxinfo " id="T6:U1094"><span class="mxinfo " id="T2:U1095"><span class="var type1" id="S2T1U1474">theta_new</span>.A</span>(<span class="mxinfo " id="T20:U1097">:</span>,<span class="mxinfo " id="T20:U1098">:</span>,<span class="var type1" id="S34T3U1478">i</span>)</span> = <span class="mxinfo " id="T6:U1100"><span class="mxinfo " id="T6:U1101"><span class="var type1" id="S24T2U1481">A_ProdPart1</span>(<span class="mxinfo " id="T20:U1103">:</span>,<span class="mxinfo " id="T20:U1104">:</span>,<span class="var type1" id="S34T3U1484">i</span>)</span> * <span class="mxinfo " id="T6:U1106">inv(<span class="mxinfo " id="T6:U1107"><span class="var type1" id="S25T2U1488">A_ProdPart2</span>(<span class="mxinfo " id="T20:U1109">:</span>,<span class="mxinfo " id="T20:U1110">:</span>,<span class="var type1" id="S34T3U1491">i</span>)</span>)</span></span></span>;   <span class="comment">%new Ai</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line">     <span class="comment">% Symmetric orthogonalization. </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line">    <span class="mxinfo " id="T6:U1112"><span class="mxinfo " id="T6:U1113"><span class="mxinfo " id="T2:U1114"><span class="var type1" id="S2T1U1496">theta_new</span>.A</span>(<span class="mxinfo " id="T20:U1116">:</span>,<span class="mxinfo " id="T20:U1117">:</span>,<span class="var type1" id="S34T3U1500">i</span>)</span> = <span class="mxinfo " id="T6:U1119"><span class="mxinfo " id="T6:U1120"><span class="mxinfo " id="T2:U1121"><span class="var type1" id="S2T1U1504">theta_new</span>.A</span>(<span class="mxinfo " id="T20:U1123">:</span>,<span class="mxinfo " id="T20:U1124">:</span>,<span class="var type1" id="S34T3U1508">i</span>)</span>*<span class="mxinfo " id="T6:U1126">real(<span class="mxinfo " id="T47:U1127">sqrtm(<span class="mxinfo " id="T6:U1128">inv(<span class="mxinfo " id="T6:U1129"><span class="mxinfo " id="T6:U1130"><span class="mxinfo " id="T6:U1131"><span class="mxinfo " id="T2:U1132"><span class="var type1" id="S2T1U1519">theta_new</span>.A</span>(<span class="mxinfo " id="T20:U1134">:</span>,<span class="mxinfo " id="T20:U1135">:</span>,<span class="var type1" id="S34T3U1523">i</span>)</span>'</span>*<span class="mxinfo " id="T6:U1137"><span class="mxinfo " id="T2:U1138"><span class="var type1" id="S2T1U1526">theta_new</span>.A</span>(<span class="mxinfo " id="T20:U1140">:</span>,<span class="mxinfo " id="T20:U1141">:</span>,<span class="var type1" id="S34T3U1530">i</span>)</span></span>)</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line"><span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S48T3U1533">v</span>=<span class="mxinfo " id="T3:U1144">1</span>:<span class="var type1" id="S21T3U1536">V</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S34T3U1539">i</span> = <span class="mxinfo " id="T3:U1147">1</span>:<span class="var type1" id="S16T3U1542">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line">            <span class="mxinfo " id="T3:U1149"><span class="mxinfo " id="T3:U1150"><span class="var type1" id="S2T1U1546">theta_new</span>.sigma1_sq</span> = <span class="mxinfo " id="T3:U1152"><span class="mxinfo " id="T3:U1153"><span class="mxinfo " id="T3:U1154"><span class="mxinfo " id="T3:U1155"><span class="var type1" id="S2T1U1552">theta_new</span>.sigma1_sq</span> + <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line">            <span class="mxinfo " id="T3:U1157"><span class="mxinfo " id="T38:U1158"><span class="mxinfo " id="T22:U1159"><span class="mxinfo " id="T48:U1160"><span class="var type1" id="S11T7U1558">Y</span>(<span class="mxinfo " id="T22:U1162">(<span class="mxinfo " id="T3:U1163"><span class="mxinfo " id="T3:U1164"><span class="mxinfo " id="T3:U1165"><span class="var type1" id="S17T3U1564">T</span>*<span class="var type1" id="S34T3U1565">i</span></span>-<span class="var type1" id="S17T3U1566">T</span></span>+<span class="mxinfo " id="T3:U1169">1</span></span>):<span class="var type1" id="S17T3U1569">T</span>*<span class="var type1" id="S34T3U1570">i</span></span>,<span class="var type1" id="S48T3U1571">v</span>)</span>'</span>*<span class="mxinfo " id="T6:U1173">diag(<span class="mxinfo " id="T4:U1174"><span class="var type1" id="S33T6U1575">C_inv</span>(<span class="mxinfo " id="T20:U1176">:</span>,<span class="var type1" id="S34T3U1577">i</span>)</span>)</span></span>*<span class="mxinfo " id="T48:U1178"><span class="var type1" id="S11T7U1579">Y</span>(<span class="mxinfo " id="T22:U1180">(<span class="mxinfo " id="T3:U1181"><span class="mxinfo " id="T3:U1182"><span class="mxinfo " id="T3:U1183"><span class="var type1" id="S17T3U1585">T</span>*<span class="var type1" id="S34T3U1586">i</span></span>-<span class="var type1" id="S17T3U1587">T</span></span>+<span class="mxinfo " id="T3:U1187">1</span></span>):<span class="var type1" id="S17T3U1590">T</span>*<span class="var type1" id="S34T3U1591">i</span></span>,<span class="var type1" id="S48T3U1592">v</span>)</span></span></span>-<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line">            <span class="mxinfo " id="T3:U1191"><span class="mxinfo " id="T38:U1192"><span class="mxinfo " id="T38:U1193"><span class="mxinfo " id="T22:U1194"><span class="mxinfo " id="T3:U1195">2</span>*<span class="mxinfo " id="T22:U1196"><span class="mxinfo " id="T48:U1197"><span class="var type1" id="S11T7U1600">Y</span>(<span class="mxinfo " id="T22:U1199">(<span class="mxinfo " id="T3:U1200"><span class="mxinfo " id="T3:U1201"><span class="mxinfo " id="T3:U1202"><span class="var type1" id="S17T3U1606">T</span>*<span class="var type1" id="S34T3U1607">i</span></span>-<span class="var type1" id="S17T3U1608">T</span></span>+<span class="mxinfo " id="T3:U1206">1</span></span>):<span class="var type1" id="S17T3U1611">T</span>*<span class="var type1" id="S34T3U1612">i</span></span>,<span class="var type1" id="S48T3U1613">v</span>)</span>'</span></span>*<span class="mxinfo " id="T6:U1210">diag(<span class="mxinfo " id="T4:U1211"><span class="var type1" id="S33T6U1617">C_inv</span>(<span class="mxinfo " id="T20:U1213">:</span>,<span class="var type1" id="S34T3U1619">i</span>)</span>)</span></span>*<span class="mxinfo " id="T6:U1215"><span class="mxinfo " id="T2:U1216"><span class="var type1" id="S2T1U1622">theta_new</span>.A</span>(<span class="mxinfo " id="T20:U1218">:</span>,<span class="mxinfo " id="T20:U1219">:</span>,<span class="var type1" id="S34T3U1626">i</span>)</span></span> * <span class="mxinfo " id="T4:U1221"><span class="var type1" id="S5T2U1628">subICmean</span>(<span class="mxinfo " id="T20:U1223">:</span>,<span class="var type1" id="S34T3U1630">i</span>,<span class="var type1" id="S48T3U1631">v</span>)</span></span></span>+ <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line">            <span class="mxinfo " id="T3:U1226">trace( <span class="mxinfo " id="T6:U1227"><span class="mxinfo " id="T6:U1228"><span class="mxinfo " id="T6:U1229"><span class="mxinfo " id="T6:U1230"><span class="mxinfo " id="T6:U1231"><span class="mxinfo " id="T2:U1232"><span class="var type1" id="S2T1U1640">theta_new</span>.A</span>(<span class="mxinfo " id="T20:U1234">:</span>,<span class="mxinfo " id="T20:U1235">:</span>,<span class="var type1" id="S34T3U1644">i</span>)</span>'</span>*<span class="mxinfo " id="T6:U1237">diag(<span class="mxinfo " id="T4:U1238"><span class="var type1" id="S33T6U1648">C_inv</span>(<span class="mxinfo " id="T20:U1240">:</span>,<span class="var type1" id="S34T3U1650">i</span>)</span>)</span></span>* <span class="mxinfo " id="T6:U1242"><span class="mxinfo " id="T2:U1243"><span class="var type1" id="S2T1U1653">theta_new</span>.A</span>(<span class="mxinfo " id="T20:U1245">:</span>,<span class="mxinfo " id="T20:U1246">:</span>,<span class="var type1" id="S34T3U1657">i</span>)</span></span> * <span class="mxinfo " id="T6:U1248"><span class="var type1" id="S6T5U1659">subICvar</span>(<span class="mxinfo " id="T20:U1250">:</span>,<span class="mxinfo " id="T20:U1251">:</span>,<span class="var type1" id="S34T3U1662">i</span>,<span class="var type1" id="S48T3U1663">v</span>)</span></span> )</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line"><span class="mxinfo " id="T3:U1254"><span class="mxinfo " id="T3:U1255"><span class="var type1" id="S2T1U1667">theta_new</span>.sigma1_sq</span> = <span class="mxinfo " id="T3:U1257"><span class="mxinfo " id="T3:U1258"><span class="mxinfo " id="T3:U1259">1</span>/(<span class="mxinfo " id="T3:U1260"><span class="mxinfo " id="T3:U1261"><span class="var type1" id="S16T3U1675">N</span>*<span class="var type1" id="S17T3U1676">T</span></span>*<span class="var type1" id="S21T3U1677">V</span></span>)</span>*<span class="mxinfo " id="T3:U1265"><span class="var type1" id="S2T1U1679">theta_new</span>.sigma1_sq</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line"><span class="keyword">end</span>  <span class="comment">%%% end of function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,246" id="srcline246">246</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,247" id="srcline247">247</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,248" id="srcline248">248</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,249" id="srcline249">249</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,250" id="srcline250">250</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,251" id="srcline251">251</a></span><span class="line"></span></span>
</pre>
</body>
</html>
